---
marp: true
theme: gaia
paginate: true
header: '5.5-实际项目集成'
style: |
  section {
    font-size: 30px;
  }
---

<!-- _class: lead -->
# 第5章 AI集成 🤖

## 5.5 实际项目集成

**构建完整的AI聊天应用**

---

## 🎯 学习目标

- **将AI功能完整集成到Next.js项目中**
- **实现前后端的无缝连接**
- **掌握生产环境的部署配置**
- **建立完整的AI聊天应用**

让所有组件完美协作！

---

## 📚 完整项目架构

### 项目结构回顾
```
app/
├── agent/                 # AI相关代码
│   ├── chatbot.ts        # LangGraph主要逻辑
│   ├── config/           # 配置文件
│   └── db.ts            # 数据库连接
├── api/                  # API路由
│   └── chat/            # 聊天相关接口
├── components/          # React组件
└── utils/              # 工具函数
```

清晰的架构是成功项目的基础！

---

## 🏗️ 环境配置管理

### 环境变量配置
```typescript
// app/utils/loadEnv.ts
export const config = {
  openai: {
    apiKey: process.env.OPENAI_API_KEY,
    modelName: process.env.OPENAI_MODEL_NAME || 'qwen-plus'
  },
  database: {
    path: process.env.DATABASE_PATH || './chat_history.db'
  }
};

// 环境变量验证
export function validateEnv() {
  const requiredVars = ['OPENAI_API_KEY'];
  const missing = requiredVars.filter(key => !process.env[key]);
  if (missing.length > 0) {
    throw new Error(`缺少环境变量: ${missing.join(', ')}`);
  }
}
```

---

## 💡 AI代理完整实现

```typescript
// app/agent/index.ts
import { app } from './chatbot';
import { initDatabase } from './db';
import { validateEnv } from '../utils/loadEnv';

// 初始化AI代理
export async function initAgent() {
  try {
    validateEnv();          // 验证环境变量
    initDatabase();         // 初始化数据库
    console.log('AI代理初始化成功');
    return app;
  } catch (error) {
    console.error('AI代理初始化失败:', error);
    throw error;
  }
}

export { app } from './chatbot';
```

系统化的初始化确保应用稳定运行！

---

## 🔗 完整API路由实现

```typescript
// app/api/chat/route.ts - 生产级实现
export async function POST(request: NextRequest) {
  try {
    const { message, threadId } = await request.json();

    // 参数验证
    if (!message?.trim() || !threadId) {
      return NextResponse.json({
        success: false,
        error: '参数不完整'
      }, { status: 400 });
    }

    // 创建流式响应
    const stream = new ReadableStream({
      async start(controller) {
        // 使用LangGraphJS处理消息
        for await (const event of app.streamEvents(
          { messages: [new HumanMessage(message.trim())] },
          { version: 'v2', configurable: { thread_id: threadId } }
        )) {
          if (event.event === 'on_chat_model_stream') {
            const chunk = event.data?.chunk;
            if (chunk?.content) {
              controller.enqueue(/* 流式数据 */);
            }
          }
        }
        controller.close();
      }
    });

    return new Response(stream);
  } catch (error) {
    return NextResponse.json({ success: false, error: '服务器错误' });
  }
}
```

---

## 🔗 前端完整集成

```typescript
// app/page.tsx - 主页面集成
'use client';

export default function ChatPage() {
  const [isLoading, setIsLoading] = useState(true);
  const {
    currentSessionId,
    sessionHistory,
    createNewSession
  } = useSessionManager();

  useEffect(() => {
    if (currentSessionId) {
      setIsLoading(false);
    }
  }, [currentSessionId]);

  if (isLoading) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <div className="text-lg">正在初始化AI聊天...</div>
      </div>
    );
  }

  return (
    <div className="container mx-auto max-w-4xl h-screen">
      <ChatInterface sessionId={currentSessionId} />
    </div>
  );
}
```

---

## 🌟 生产环境优化

### 部署前检查清单
- ✅ **环境变量配置正确**
- ✅ **数据库文件路径设置**
- ✅ **API接口测试通过**
- ✅ **前端界面正常显示**
- ✅ **流式响应工作正常**
- ✅ **错误处理机制完善**

### 性能优化配置
```typescript
const productionConfig = {
  // 启用API限流
  rateLimit: {
    windowMs: 15 * 60 * 1000,  // 15分钟
    max: 100                   // 最多100次请求
  },
  
  // 数据库优化
  database: {
    path: '/app/data/chat_history.db',
    backup: true,
    compression: true
  }
};
```

---

## 🔧 错误监控和日志

```typescript
// 生产环境监控
export function logAPICall(endpoint: string, success: boolean, duration: number) {
  console.log(`API调用: ${endpoint}, 成功: ${success}, 耗时: ${duration}ms`);
  
  // 生产环境发送到监控系统
  if (!success && process.env.NODE_ENV === 'production') {
    // 发送错误报告到监控服务
  }
}

// 应用健康检查
export async function healthCheck() {
  try {
    await validateEnv();
    await testDatabaseConnection();
    await testAIConnection();
    return { status: 'healthy' };
  } catch (error) {
    return { status: 'unhealthy', error: error.message };
  }
}
```

---

## 🔧 部署配置示例

### Docker部署配置
```dockerfile
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build

# 环境变量
ENV NODE_ENV=production
ENV DATABASE_PATH=/app/data/chat_history.db

EXPOSE 3000
CMD ["npm", "start"]
```

### Vercel部署配置
```json
{
  "env": {
    "OPENAI_API_KEY": "@openai-api-key",
    "OPENAI_MODEL_NAME": "qwen-plus",
    "NODE_ENV": "production"
  }
}
```

---

## 📋 总结要点

- **完整集成** - 前端、后端、AI和数据库的无缝整合
- **环境管理** - 开发、测试、生产环境的配置管理
- **错误处理** - 生产级别的错误处理和监控
- **性能优化** - 流式响应和数据库的性能调优
- **部署就绪** - 支持多种部署方式的配置

完整的项目集成让AI应用走向生产！

---

## 🚀 下一步预告

完成了实际项目集成后，我们将学习：

**5.6 错误处理实践**
- 健壮的AI应用错误处理机制
- 各种错误场景的处理策略
- 用户友好的错误提示
- 应用可靠性和稳定性提升

让AI应用更加可靠稳定！
