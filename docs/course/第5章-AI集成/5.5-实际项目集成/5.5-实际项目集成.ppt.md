---
marp: true
theme: gaia
paginate: true
header: '5.5-å®é™…é¡¹ç›®é›†æˆ'
style: |
  section {
    font-size: 30px;
  }
---

<!-- _class: lead -->
# ç¬¬5ç«  AIé›†æˆ ğŸ¤–

## 5.5 å®é™…é¡¹ç›®é›†æˆ

**æ„å»ºå®Œæ•´çš„AIèŠå¤©åº”ç”¨**

---

## ğŸ¯ å­¦ä¹ ç›®æ ‡

- **å°†AIåŠŸèƒ½å®Œæ•´é›†æˆåˆ°Next.jsé¡¹ç›®ä¸­**
- **å®ç°å‰åç«¯çš„æ— ç¼è¿æ¥**
- **æŒæ¡ç”Ÿäº§ç¯å¢ƒçš„éƒ¨ç½²é…ç½®**
- **å»ºç«‹å®Œæ•´çš„AIèŠå¤©åº”ç”¨**

è®©æ‰€æœ‰ç»„ä»¶å®Œç¾åä½œï¼

---

## ğŸ“š å®Œæ•´é¡¹ç›®æ¶æ„

### é¡¹ç›®ç»“æ„å›é¡¾
```
app/
â”œâ”€â”€ agent/                 # AIç›¸å…³ä»£ç 
â”‚   â”œâ”€â”€ chatbot.ts        # LangGraphä¸»è¦é€»è¾‘
â”‚   â”œâ”€â”€ config/           # é…ç½®æ–‡ä»¶
â”‚   â””â”€â”€ db.ts            # æ•°æ®åº“è¿æ¥
â”œâ”€â”€ api/                  # APIè·¯ç”±
â”‚   â””â”€â”€ chat/            # èŠå¤©ç›¸å…³æ¥å£
â”œâ”€â”€ components/          # Reactç»„ä»¶
â””â”€â”€ utils/              # å·¥å…·å‡½æ•°
```

æ¸…æ™°çš„æ¶æ„æ˜¯æˆåŠŸé¡¹ç›®çš„åŸºç¡€ï¼

---

## ğŸ—ï¸ ç¯å¢ƒé…ç½®ç®¡ç†

### ç¯å¢ƒå˜é‡é…ç½®
```typescript
// app/utils/loadEnv.ts
export const config = {
  openai: {
    apiKey: process.env.OPENAI_API_KEY,
    modelName: process.env.OPENAI_MODEL_NAME || 'qwen-plus'
  },
  database: {
    path: process.env.DATABASE_PATH || './chat_history.db'
  }
};

// ç¯å¢ƒå˜é‡éªŒè¯
export function validateEnv() {
  const requiredVars = ['OPENAI_API_KEY'];
  const missing = requiredVars.filter(key => !process.env[key]);
  if (missing.length > 0) {
    throw new Error(`ç¼ºå°‘ç¯å¢ƒå˜é‡: ${missing.join(', ')}`);
  }
}
```

---

## ğŸ’¡ AIä»£ç†å®Œæ•´å®ç°

```typescript
// app/agent/index.ts
import { app } from './chatbot';
import { initDatabase } from './db';
import { validateEnv } from '../utils/loadEnv';

// åˆå§‹åŒ–AIä»£ç†
export async function initAgent() {
  try {
    validateEnv();          // éªŒè¯ç¯å¢ƒå˜é‡
    initDatabase();         // åˆå§‹åŒ–æ•°æ®åº“
    console.log('AIä»£ç†åˆå§‹åŒ–æˆåŠŸ');
    return app;
  } catch (error) {
    console.error('AIä»£ç†åˆå§‹åŒ–å¤±è´¥:', error);
    throw error;
  }
}

export { app } from './chatbot';
```

ç³»ç»ŸåŒ–çš„åˆå§‹åŒ–ç¡®ä¿åº”ç”¨ç¨³å®šè¿è¡Œï¼

---

## ğŸ”— å®Œæ•´APIè·¯ç”±å®ç°

```typescript
// app/api/chat/route.ts - ç”Ÿäº§çº§å®ç°
export async function POST(request: NextRequest) {
  try {
    const { message, threadId } = await request.json();

    // å‚æ•°éªŒè¯
    if (!message?.trim() || !threadId) {
      return NextResponse.json({
        success: false,
        error: 'å‚æ•°ä¸å®Œæ•´'
      }, { status: 400 });
    }

    // åˆ›å»ºæµå¼å“åº”
    const stream = new ReadableStream({
      async start(controller) {
        // ä½¿ç”¨LangGraphJSå¤„ç†æ¶ˆæ¯
        for await (const event of app.streamEvents(
          { messages: [new HumanMessage(message.trim())] },
          { version: 'v2', configurable: { thread_id: threadId } }
        )) {
          if (event.event === 'on_chat_model_stream') {
            const chunk = event.data?.chunk;
            if (chunk?.content) {
              controller.enqueue(/* æµå¼æ•°æ® */);
            }
          }
        }
        controller.close();
      }
    });

    return new Response(stream);
  } catch (error) {
    return NextResponse.json({ success: false, error: 'æœåŠ¡å™¨é”™è¯¯' });
  }
}
```

---

## ğŸ”— å‰ç«¯å®Œæ•´é›†æˆ

```typescript
// app/page.tsx - ä¸»é¡µé¢é›†æˆ
'use client';

export default function ChatPage() {
  const [isLoading, setIsLoading] = useState(true);
  const {
    currentSessionId,
    sessionHistory,
    createNewSession
  } = useSessionManager();

  useEffect(() => {
    if (currentSessionId) {
      setIsLoading(false);
    }
  }, [currentSessionId]);

  if (isLoading) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <div className="text-lg">æ­£åœ¨åˆå§‹åŒ–AIèŠå¤©...</div>
      </div>
    );
  }

  return (
    <div className="container mx-auto max-w-4xl h-screen">
      <ChatInterface sessionId={currentSessionId} />
    </div>
  );
}
```

---

## ğŸŒŸ ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–

### éƒ¨ç½²å‰æ£€æŸ¥æ¸…å•
- âœ… **ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡®**
- âœ… **æ•°æ®åº“æ–‡ä»¶è·¯å¾„è®¾ç½®**
- âœ… **APIæ¥å£æµ‹è¯•é€šè¿‡**
- âœ… **å‰ç«¯ç•Œé¢æ­£å¸¸æ˜¾ç¤º**
- âœ… **æµå¼å“åº”å·¥ä½œæ­£å¸¸**
- âœ… **é”™è¯¯å¤„ç†æœºåˆ¶å®Œå–„**

### æ€§èƒ½ä¼˜åŒ–é…ç½®
```typescript
const productionConfig = {
  // å¯ç”¨APIé™æµ
  rateLimit: {
    windowMs: 15 * 60 * 1000,  // 15åˆ†é’Ÿ
    max: 100                   // æœ€å¤š100æ¬¡è¯·æ±‚
  },
  
  // æ•°æ®åº“ä¼˜åŒ–
  database: {
    path: '/app/data/chat_history.db',
    backup: true,
    compression: true
  }
};
```

---

## ğŸ”§ é”™è¯¯ç›‘æ§å’Œæ—¥å¿—

```typescript
// ç”Ÿäº§ç¯å¢ƒç›‘æ§
export function logAPICall(endpoint: string, success: boolean, duration: number) {
  console.log(`APIè°ƒç”¨: ${endpoint}, æˆåŠŸ: ${success}, è€—æ—¶: ${duration}ms`);
  
  // ç”Ÿäº§ç¯å¢ƒå‘é€åˆ°ç›‘æ§ç³»ç»Ÿ
  if (!success && process.env.NODE_ENV === 'production') {
    // å‘é€é”™è¯¯æŠ¥å‘Šåˆ°ç›‘æ§æœåŠ¡
  }
}

// åº”ç”¨å¥åº·æ£€æŸ¥
export async function healthCheck() {
  try {
    await validateEnv();
    await testDatabaseConnection();
    await testAIConnection();
    return { status: 'healthy' };
  } catch (error) {
    return { status: 'unhealthy', error: error.message };
  }
}
```

---

## ğŸ”§ éƒ¨ç½²é…ç½®ç¤ºä¾‹

### Dockeréƒ¨ç½²é…ç½®
```dockerfile
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build

# ç¯å¢ƒå˜é‡
ENV NODE_ENV=production
ENV DATABASE_PATH=/app/data/chat_history.db

EXPOSE 3000
CMD ["npm", "start"]
```

### Verceléƒ¨ç½²é…ç½®
```json
{
  "env": {
    "OPENAI_API_KEY": "@openai-api-key",
    "OPENAI_MODEL_NAME": "qwen-plus",
    "NODE_ENV": "production"
  }
}
```

---

## ğŸ“‹ æ€»ç»“è¦ç‚¹

- **å®Œæ•´é›†æˆ** - å‰ç«¯ã€åç«¯ã€AIå’Œæ•°æ®åº“çš„æ— ç¼æ•´åˆ
- **ç¯å¢ƒç®¡ç†** - å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒçš„é…ç½®ç®¡ç†
- **é”™è¯¯å¤„ç†** - ç”Ÿäº§çº§åˆ«çš„é”™è¯¯å¤„ç†å’Œç›‘æ§
- **æ€§èƒ½ä¼˜åŒ–** - æµå¼å“åº”å’Œæ•°æ®åº“çš„æ€§èƒ½è°ƒä¼˜
- **éƒ¨ç½²å°±ç»ª** - æ”¯æŒå¤šç§éƒ¨ç½²æ–¹å¼çš„é…ç½®

å®Œæ•´çš„é¡¹ç›®é›†æˆè®©AIåº”ç”¨èµ°å‘ç”Ÿäº§ï¼

---

## ğŸš€ ä¸‹ä¸€æ­¥é¢„å‘Š

å®Œæˆäº†å®é™…é¡¹ç›®é›†æˆåï¼Œæˆ‘ä»¬å°†å­¦ä¹ ï¼š

**5.6 é”™è¯¯å¤„ç†å®è·µ**
- å¥å£®çš„AIåº”ç”¨é”™è¯¯å¤„ç†æœºåˆ¶
- å„ç§é”™è¯¯åœºæ™¯çš„å¤„ç†ç­–ç•¥
- ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º
- åº”ç”¨å¯é æ€§å’Œç¨³å®šæ€§æå‡

è®©AIåº”ç”¨æ›´åŠ å¯é ç¨³å®šï¼
