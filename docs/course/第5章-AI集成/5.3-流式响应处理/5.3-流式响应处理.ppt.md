---
marp: true
theme: gaia
paginate: true
header: '5.3-æµå¼å“åº”å¤„ç†'
style: |
  section {
    font-size: 30px;
  }
---

<!-- _class: lead -->
# ç¬¬5ç«  AIé›†æˆ ğŸ¤–

## 5.3 æµå¼å“åº”å¤„ç†

**å®ç°å®æ—¶AIå¯¹è¯ä½“éªŒ**

---

## ğŸ¯ å­¦ä¹ ç›®æ ‡

- **ç†è§£LangGraphJSä¸­çš„æµå¼äº‹ä»¶ç³»ç»Ÿ**
- **æŒæ¡streamEventsçš„ä½¿ç”¨æ–¹æ³•**
- **å®ç°å®æ—¶çš„AIå¯¹è¯ä½“éªŒ**
- **ä¼˜åŒ–æµå¼å“åº”çš„æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒ**

è®©AIå¯¹è¯å¦‚ä¸èˆ¬é¡ºæ»‘ï¼

---

## ğŸ“š æµå¼äº‹ä»¶ç³»ç»ŸåŸç†

### streamEventsåŸºç¡€ç”¨æ³•
```typescript
for await (const event of app.streamEvents(
  { messages: [new HumanMessage('ä½ å¥½')] },
  { version: 'v2', configurable: { thread_id: 'session-1' } }
)) {
  // å¤„ç†ä¸åŒç±»å‹çš„äº‹ä»¶
  if (event.event === 'on_chat_model_stream') {
    const chunk = event.data?.chunk;
    if (chunk?.content) {
      console.log(chunk.content); // å®æ—¶è¾“å‡ºAIå›å¤
    }
  }
}
```

å®æ—¶è·å–AIè¾“å‡ºï¼Œæ— éœ€ç­‰å¾…å®Œæ•´å›å¤ï¼

---

## ğŸ—ï¸ æ ¸å¿ƒäº‹ä»¶ç±»å‹

### é‡è¦äº‹ä»¶è¯¦è§£
- **`on_chat_model_stream`** - AIæ¨¡å‹çš„æµå¼è¾“å‡º â­
- **`on_chain_start`** - å·¥ä½œæµå¼€å§‹
- **`on_chain_end`** - å·¥ä½œæµç»“æŸ
- **`on_chain_stream`** - é“¾å¼æµè¾“å‡º

é‡ç‚¹å…³æ³¨ `on_chat_model_stream`ï¼Œè¿™æ˜¯å®æ—¶å¯¹è¯çš„æ ¸å¿ƒï¼

---

## ğŸ’¡ APIè·¯ç”±æµå¼å®ç°

```typescript
// app/api/chat/route.ts
export async function POST(request: NextRequest) {
  const { message, threadId } = await request.json();

  const stream = new ReadableStream({
    async start(controller) {
      const encoder = new TextEncoder();
      
      for await (const event of app.streamEvents(
        { messages: [new HumanMessage(message)] },
        { version: 'v2', configurable: { thread_id: threadId } }
      )) {
        if (event.event === 'on_chat_model_stream') {
          const chunk = event.data?.chunk;
          if (chunk?.content) {
            controller.enqueue(encoder.encode(
              JSON.stringify({ type: 'chunk', content: chunk.content }) + '\n'
            ));
          }
        }
      }
      controller.close();
    }
  });

  return new Response(stream);
}
```

---

## ğŸ”— å‰ç«¯æµå¼æ•°æ®æ¥æ”¶

```typescript
async function sendMessageWithStream(message: string, threadId: string) {
  const response = await fetch('/api/chat', {
    method: 'POST',
    body: JSON.stringify({ message, threadId })
  });

  const reader = response.body?.getReader();
  const decoder = new TextDecoder();

  while (true) {
    const { done, value } = await reader.read();
    if (done) break;

    const chunk = decoder.decode(value);
    const data = JSON.parse(chunk);
    
    if (data.type === 'chunk') {
      // å®æ—¶æ›´æ–°ç•Œé¢
      setStreamingContent(prev => prev + data.content);
    }
  }
}
```

---

## ğŸŒŸ ç”¨æˆ·ä½“éªŒä¼˜åŒ–

### æ‰“å­—æœºæ•ˆæœå®ç°
```typescript
// å‰ç«¯çŠ¶æ€ç®¡ç†
const [streamingContent, setStreamingContent] = useState('');
const [isStreaming, setIsStreaming] = useState(false);

// æµå¼å†…å®¹æ›´æ–°
if (data.type === 'chunk') {
  setStreamingContent(prev => prev + data.content);
} else if (data.type === 'end') {
  setIsStreaming(false);
}
```

### è§†è§‰æ•ˆæœ
- **å…‰æ ‡é—ªçƒ** - è¡¨ç¤ºAIæ­£åœ¨"æ€è€ƒ"
- **é€å­—æ˜¾ç¤º** - æ¨¡æ‹ŸçœŸå®çš„æ‰“å­—è¿‡ç¨‹
- **åŠ è½½åŠ¨ç”»** - ç­‰å¾…å“åº”æ—¶çš„è§†è§‰åé¦ˆ

---

## ğŸ”§ æ€§èƒ½ä¼˜åŒ–æŠ€å·§

### å‰ç«¯ä¼˜åŒ–ç­–ç•¥
```typescript
// ä½¿ç”¨bufferé¿å…é¢‘ç¹DOMæ›´æ–°
let buffer = '';
const lines = buffer.split('\n');
buffer = lines.pop() || '';

// æ‰¹é‡å¤„ç†å¤šè¡Œæ•°æ®
for (const line of lines) {
  if (line.trim()) {
    const data = JSON.parse(line);
    // å¤„ç†æ•°æ®...
  }
}
```

### é”™è¯¯å¤„ç†å’Œæ¢å¤
- **ç½‘ç»œä¸­æ–­æ£€æµ‹** - è‡ªåŠ¨é‡è¿æœºåˆ¶
- **æµä¸­æ–­å¤„ç†** - ä¼˜é›…çš„é”™è¯¯æ¢å¤
- **å†…å­˜ç®¡ç†** - åŠæ—¶æ¸…ç†å®Œæˆçš„æµ

---

## ğŸ”§ è°ƒè¯•å’Œç›‘æ§

```typescript
// æ·»åŠ è¯¦ç»†çš„æµå¼äº‹ä»¶ç›‘æ§
for await (const event of app.streamEvents(...)) {
  console.log('äº‹ä»¶ç±»å‹:', event.event);
  
  if (event.event === 'on_chat_model_stream') {
    const chunk = event.data?.chunk;
    console.log('å†…å®¹å—é•¿åº¦:', chunk?.content?.length || 0);
    console.log('ç´¯è®¡å†…å®¹:', totalContent.length);
  }
}
```

è¯¦ç»†çš„ç›‘æ§è®©æµå¼å¤„ç†æ›´å¯æ§ï¼

---

## ğŸ“‹ æ€»ç»“è¦ç‚¹

- **streamEventsç³»ç»Ÿ** - LangGraphJSçš„å¼ºå¤§æµå¼èƒ½åŠ›
- **äº‹ä»¶é©±åŠ¨** - åŸºäºäº‹ä»¶çš„æµå¼æ•°æ®å¤„ç†æ¨¡å¼
- **å®æ—¶ä½“éªŒ** - æµå¼å“åº”æ˜¾è‘—æå‡ç”¨æˆ·ä½“éªŒ
- **æ€§èƒ½ä¼˜åŒ–** - åˆç†çš„ç¼“å†²å’Œæ‰¹å¤„ç†æœºåˆ¶
- **é”™è¯¯å¤„ç†** - å¥å£®çš„æµå¼é”™è¯¯å¤„ç†æœºåˆ¶

æµå¼å“åº”è®©AIå¯¹è¯æ›´æœ‰æ¸©åº¦ï¼

---

## ğŸš€ ä¸‹ä¸€æ­¥é¢„å‘Š

æŒæ¡äº†æµå¼å“åº”å¤„ç†åï¼Œæˆ‘ä»¬å°†å­¦ä¹ ï¼š

**5.4 ä¼šè¯å’ŒçŠ¶æ€ç®¡ç†**
- Threadä¼šè¯ç®¡ç†æœºåˆ¶
- æ£€æŸ¥ç‚¹çŠ¶æ€æŒä¹…åŒ–
- å¤šè½®å¯¹è¯çŠ¶æ€ç®¡ç†
- å†å²è®°å½•åŠŸèƒ½å®ç°

è®©AIè®°ä½æ¯ä¸€æ¬¡å¯¹è¯ï¼
