---
marp: true
theme: gaia
paginate: true
header: '5.6-é”™è¯¯å¤„ç†å®è·µ'
style: |
  section {
    font-size: 30px;
  }
---

<!-- _class: lead -->
# ç¬¬5ç«  AIé›†æˆ ğŸ¤–

## 5.6 é”™è¯¯å¤„ç†å®è·µ

**æ„å»ºå¯é ç¨³å®šçš„AIåº”ç”¨**

---

## ğŸ¯ å­¦ä¹ ç›®æ ‡

- **å»ºç«‹å¥å£®çš„AIåº”ç”¨é”™è¯¯å¤„ç†æœºåˆ¶**
- **æŒæ¡å„ç§é”™è¯¯åœºæ™¯çš„å¤„ç†ç­–ç•¥**
- **å®ç°ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º**
- **æå‡AIåº”ç”¨çš„å¯é æ€§å’Œç¨³å®šæ€§**

è®©AIåº”ç”¨åœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½èƒ½ä¼˜é›…è¿è¡Œï¼

---

## ğŸ“š AIåº”ç”¨é”™è¯¯ç±»å‹

### å¸¸è§é”™è¯¯åˆ†ç±»
```typescript
enum ErrorType {
  NETWORK_ERROR = 'network_error',           // ç½‘ç»œè¿æ¥é—®é¢˜
  API_RATE_LIMIT = 'api_rate_limit',        // APIè°ƒç”¨é™åˆ¶
  MODEL_ERROR = 'model_error',              // AIæ¨¡å‹é”™è¯¯
  VALIDATION_ERROR = 'validation_error',     // è¾“å…¥éªŒè¯é”™è¯¯
  STATE_ERROR = 'state_error',              // çŠ¶æ€ç®¡ç†é”™è¯¯
  UNKNOWN_ERROR = 'unknown_error'           // æœªçŸ¥é”™è¯¯
}
```

AIåº”ç”¨é¢ä¸´çš„é”™è¯¯æ¯”ä¼ ç»Ÿåº”ç”¨æ›´å¤æ‚ï¼

---

## ğŸ—ï¸ é”™è¯¯å¤„ç†ç­–ç•¥

### é”™è¯¯å¤„ç†åŸåˆ™
- **ç”¨æˆ·å‹å¥½** - é”™è¯¯ä¿¡æ¯è¦è®©ç”¨æˆ·èƒ½ç†è§£
- **å¯æ¢å¤æ€§** - å°½å¯èƒ½æä¾›æ¢å¤æ–¹æ¡ˆ
- **æ—¥å¿—è®°å½•** - è¯¦ç»†è®°å½•é”™è¯¯ä¿¡æ¯ç”¨äºè°ƒè¯•
- **ä¼˜é›…é™çº§** - åœ¨æœåŠ¡ä¸å¯ç”¨æ—¶æä¾›å¤‡é€‰æ–¹æ¡ˆ

### é”™è¯¯ç±»å‹åˆ¤æ–­
```typescript
// é”™è¯¯ç±»å‹æ˜ å°„
private static errorTypeMap = {
  'insufficient_quota': ErrorType.API_RATE_LIMIT,
  'rate_limit_exceeded': ErrorType.API_RATE_LIMIT,
  'model_overloaded': ErrorType.MODEL_ERROR,
  'invalid_request_error': ErrorType.VALIDATION_ERROR,
};
```

---

## ğŸ’¡ ç»Ÿä¸€é”™è¯¯å¤„ç†ç±»

```typescript
// app/utils/errorHandler.ts
export class AIErrorHandler {
  // è·å–é”™è¯¯ç±»å‹
  static getErrorType(error: any): ErrorType {
    if (error?.code && this.errorTypeMap[error.code]) {
      return this.errorTypeMap[error.code];
    }
    if (error?.message?.includes('network')) {
      return ErrorType.NETWORK_ERROR;
    }
    return ErrorType.UNKNOWN_ERROR;
  }

  // è·å–ç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯
  static getUserMessage(errorType: ErrorType): string {
    const messages = {
      [ErrorType.NETWORK_ERROR]: 'ç½‘ç»œè¿æ¥ä¸ç¨³å®šï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•',
      [ErrorType.API_RATE_LIMIT]: 'AIæœåŠ¡ä½¿ç”¨é¢‘ç¹ï¼Œè¯·ç¨åå†è¯•',
      [ErrorType.MODEL_ERROR]: 'AIæ¨¡å‹æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•'
    };
    return messages[errorType] || 'æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•';
  }
}
```

---

## ğŸ”— APIé”™è¯¯å¤„ç†å®ç°

```typescript
// app/api/chat/route.ts - å¢å¼ºé”™è¯¯å¤„ç†
export async function POST(request: NextRequest) {
  const maxRetries = 3;
  
  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      // APIè°ƒç”¨é€»è¾‘...
      return response;
      
    } catch (error) {
      const errorType = AIErrorHandler.getErrorType(error);
      
      // åˆ¤æ–­æ˜¯å¦å¯ä»¥é‡è¯•
      if (AIErrorHandler.isRetryable(errorType) && attempt < maxRetries) {
        const delay = AIErrorHandler.getRetryDelay(errorType, attempt);
        await new Promise(resolve => setTimeout(resolve, delay));
        continue;
      }
      
      // è¿”å›ç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯
      const userMessage = AIErrorHandler.getUserMessage(errorType);
      return NextResponse.json({
        success: false,
        error: userMessage,
        errorType
      }, { status: 500 });
    }
  }
}
```

---

## ğŸ”— é‡è¯•æœºåˆ¶å®ç°

```typescript
// åˆ¤æ–­æ˜¯å¦å¯ä»¥é‡è¯•
static isRetryable(errorType: ErrorType): boolean {
  return [
    ErrorType.NETWORK_ERROR,
    ErrorType.MODEL_ERROR,
    ErrorType.API_RATE_LIMIT
  ].includes(errorType);
}

// è·å–é‡è¯•å»¶è¿Ÿæ—¶é—´ï¼ˆæŒ‡æ•°é€€é¿ï¼‰
static getRetryDelay(errorType: ErrorType, attempt: number): number {
  const baseDelays = {
    [ErrorType.NETWORK_ERROR]: 1000,    // 1ç§’
    [ErrorType.MODEL_ERROR]: 2000,     // 2ç§’
    [ErrorType.API_RATE_LIMIT]: 5000   // 5ç§’
  };
  
  const baseDelay = baseDelays[errorType] || 1000;
  return baseDelay * Math.pow(2, attempt - 1); // æŒ‡æ•°é€€é¿
}
```

æ™ºèƒ½é‡è¯•è®©åº”ç”¨æ›´å¯é ï¼

---

## ğŸŒŸ å‰ç«¯é”™è¯¯å¤„ç†

```typescript
// å‰ç«¯é”™è¯¯å¤„ç†Hook
export function useErrorHandler() {
  const [error, setError] = useState<string | null>(null);
  const [isRetrying, setIsRetrying] = useState(false);

  const handleStreamError = async (errorData: any, retryFunction: () => Promise<void>) => {
    setError(errorData.message);
    
    // å¦‚æœé”™è¯¯å¯é‡è¯•ï¼Œæä¾›é‡è¯•é€‰é¡¹
    if (errorData.retryable && !isRetrying) {
      setIsRetrying(true);
      
      setTimeout(async () => {
        try {
          await retryFunction();
          setError(null);
        } catch (retryError) {
          setError('é‡è¯•å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é‡æ–°å‘é€æ¶ˆæ¯');
        } finally {
          setIsRetrying(false);
        }
      }, 5000);
    }
  };

  return { error, isRetrying, handleStreamError, clearError: () => setError(null) };
}
```

---

## ğŸ”§ é”™è¯¯ç›‘æ§å’Œæ—¥å¿—

```typescript
// é”™è¯¯ç›‘æ§ç³»ç»Ÿ
export class ErrorMonitor {
  static logError(error: any, context: string) {
    const errorInfo = {
      timestamp: new Date().toISOString(),
      context,
      message: error.message,
      stack: error.stack,
      type: AIErrorHandler.getErrorType(error)
    };
    
    console.error('é”™è¯¯æ—¥å¿—:', errorInfo);
    
    // ç”Ÿäº§ç¯å¢ƒå‘é€åˆ°ç›‘æ§æœåŠ¡
    if (process.env.NODE_ENV === 'production') {
      // å‘é€åˆ°Sentryç­‰ç›‘æ§æœåŠ¡
    }
  }
}

// åº”ç”¨å¥åº·æ£€æŸ¥
export async function healthCheck() {
  try {
    await testAIConnection();
    await testDatabaseConnection();
    return { status: 'healthy' };
  } catch (error) {
    ErrorMonitor.logError(error, 'health-check');
    return { status: 'unhealthy', error: error.message };
  }
}
```

---

## ğŸ”§ ç”¨æˆ·ä½“éªŒä¼˜åŒ–

### é”™è¯¯UIè®¾è®¡
```typescript
// é”™è¯¯æç¤ºç»„ä»¶
function ErrorMessage({ error, onRetry, isRetrying }: ErrorMessageProps) {
  return (
    <div className="bg-red-50 border border-red-200 rounded-lg p-4">
      <div className="flex items-center">
        <ExclamationTriangleIcon className="h-5 w-5 text-red-400" />
        <p className="ml-2 text-red-800">{error}</p>
      </div>
      
      {onRetry && (
        <button 
          onClick={onRetry}
          disabled={isRetrying}
          className="mt-2 px-4 py-2 bg-red-600 text-white rounded"
        >
          {isRetrying ? 'é‡è¯•ä¸­...' : 'é‡è¯•'}
        </button>
      )}
    </div>
  );
}
```

### ä¼˜é›…é™çº§ç­–ç•¥
- **AIä¸å¯ç”¨æ—¶**ï¼šæä¾›é¢„è®¾å›å¤æˆ–å»ºè®®
- **ç½‘ç»œé—®é¢˜**ï¼šç¦»çº¿æ¨¡å¼æç¤º
- **æµå¼ä¸­æ–­**ï¼šæ˜¾ç¤ºå·²æ¥æ”¶çš„å†…å®¹

---

## ğŸ“‹ æ€»ç»“è¦ç‚¹

- **é”™è¯¯åˆ†ç±»** - ä¸åŒç±»å‹çš„é”™è¯¯éœ€è¦ä¸åŒå¤„ç†ç­–ç•¥
- **ç”¨æˆ·ä½“éªŒ** - é”™è¯¯ä¿¡æ¯è¦å‹å¥½ï¼Œæä¾›æ˜ç¡®è§£å†³æ–¹æ¡ˆ
- **è‡ªåŠ¨æ¢å¤** - å®ç°é‡è¯•æœºåˆ¶å’Œé™çº§ç­–ç•¥
- **ç›‘æ§æ—¥å¿—** - å®Œå–„çš„é”™è¯¯ç›‘æ§æœ‰åŠ©äºé—®é¢˜å®šä½
- **å¥åº·æ£€æŸ¥** - å®šæœŸæ£€æŸ¥ç³»ç»Ÿå„ç»„ä»¶çŠ¶æ€

å¥å£®çš„é”™è¯¯å¤„ç†è®©AIåº”ç”¨æ›´ä¸“ä¸šï¼

---

## ğŸš€ ç¬¬5ç« æ€»ç»“

æ­å–œå®Œæˆç¬¬5ç« AIé›†æˆçš„å­¦ä¹ ï¼æ‚¨ç°åœ¨å·²ç»æŒæ¡äº†ï¼š

- âœ… **OpenAI APIæ·±åº¦åº”ç”¨**
- âœ… **LangGraphJSçŠ¶æ€å›¾æ„å»º**
- âœ… **æµå¼å“åº”å®Œæ•´å®ç°**
- âœ… **ä¼šè¯å’ŒçŠ¶æ€ç®¡ç†**
- âœ… **é¡¹ç›®å®Œæ•´é›†æˆ**
- âœ… **å¥å£®é”™è¯¯å¤„ç†æœºåˆ¶**

**ä¸‹ä¸€æ­¥ï¼šç¬¬6ç« æ ¸å¿ƒåŠŸèƒ½**
æ„å»ºå®Œæ•´çš„èŠå¤©æœºå™¨äººåº”ç”¨ï¼

