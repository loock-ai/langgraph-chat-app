---
marp: true
theme: gaia
paginate: true
header: '5.4-ä¼šè¯å’ŒçŠ¶æ€ç®¡ç†'
style: |
  section {
    font-size: 30px;
  }
---

<!-- _class: lead -->
# ç¬¬5ç«  AIé›†æˆ ğŸ¤–

## 5.4 ä¼šè¯å’ŒçŠ¶æ€ç®¡ç†

**è®©AIè®°ä½æ¯ä¸€æ¬¡å¯¹è¯**

---

## ğŸ¯ å­¦ä¹ ç›®æ ‡

- **ç†è§£LangGraphJSä¸­çš„ä¼šè¯ç®¡ç†æœºåˆ¶**
- **æŒæ¡Threadé…ç½®å’ŒçŠ¶æ€æŒä¹…åŒ–**
- **å­¦ä¼šå¤šè½®å¯¹è¯çš„çŠ¶æ€ç®¡ç†**
- **å®ç°å¯é çš„å†å²è®°å½•åŠŸèƒ½**

è®©AIæ‹¥æœ‰è®°å¿†ï¼Œå¯¹è¯æ›´æ™ºèƒ½ï¼

---

## ğŸ“š Threadä¼šè¯ç®¡ç†

### Threadé…ç½®åŸç†
```typescript
// æ¯ä¸ªä¼šè¯éƒ½æœ‰å”¯ä¸€çš„thread_id
const threadConfig = {
  configurable: { thread_id: 'user-123-session-456' }
};

// åœ¨è°ƒç”¨æ—¶ä¼ é€’é…ç½®
const response = await app.invoke(input, threadConfig);
```

ç‹¬ç«‹çš„ä¼šè¯IDç¡®ä¿ä¸åŒå¯¹è¯äº’ä¸å¹²æ‰°ï¼

---

## ğŸ—ï¸ æ£€æŸ¥ç‚¹çŠ¶æ€æŒä¹…åŒ–

### çŠ¶æ€ä¿å­˜å’Œæ¢å¤
```typescript
// ä¿å­˜çŠ¶æ€ï¼ˆè‡ªåŠ¨å®Œæˆï¼‰
await app.invoke(
  { messages: [new HumanMessage('ä½ å¥½')] },
  { configurable: { thread_id: sessionId } }
);

// è·å–ä¿å­˜çš„çŠ¶æ€
const savedState = await app.getState({
  configurable: { thread_id: sessionId }
});

console.log('å†å²æ¶ˆæ¯:', savedState?.values?.messages || []);
```

SqliteSaverè‡ªåŠ¨ä¿å­˜ï¼Œéšæ—¶æ¢å¤å¯¹è¯ï¼

---

## ğŸ’¡ ä¼šè¯ç®¡ç†å·¥å…·ç±»

```typescript
// app/utils/sessionManager.ts
export class SessionManager {
  // ç”Ÿæˆæ–°çš„ä¼šè¯ID
  static generateSessionId(): string {
    return `session-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
  }

  // è·å–ä¼šè¯å†å²
  static async getSessionHistory(sessionId: string) {
    const state = await app.getState({
      configurable: { thread_id: sessionId }
    });
    return state?.values?.messages || [];
  }

  // æ£€æŸ¥ä¼šè¯æ˜¯å¦å­˜åœ¨
  static async sessionExists(sessionId: string): Promise<boolean> {
    const state = await app.getState({
      configurable: { thread_id: sessionId }
    });
    return state?.values?.messages?.length > 0;
  }
}
```

---

## ğŸ”— APIå†å²è®°å½•å¤„ç†

```typescript
// app/api/chat/route.ts - GETæ–¹æ³•
export async function GET(request: NextRequest) {
  const { searchParams } = new URL(request.url);
  const threadId = searchParams.get('threadId');

  try {
    const history = await SessionManager.getSessionHistory(threadId);
    
    // è½¬æ¢ä¸ºå‰ç«¯æ ¼å¼
    const messages = history.map((msg: any, index: number) => {
      let role: 'user' | 'assistant' = 'assistant';
      
      if (msg.constructor.name === 'HumanMessage') {
        role = 'user';
      }
      
      return {
        id: String(index + 1),
        content: msg.content || '',
        role,
        timestamp: new Date().toISOString(),
        sessionId: threadId
      };
    });

    return NextResponse.json({ success: true, data: { history: messages } });
  } catch (error) {
    return NextResponse.json({ success: false, error: 'è·å–å†å²å¤±è´¥' });
  }
}
```

---

## ğŸ”— å‰ç«¯ä¼šè¯çŠ¶æ€ç®¡ç†

```typescript
// å‰ç«¯ä¼šè¯ç®¡ç†Hook
export function useSessionManager() {
  const [currentSessionId, setCurrentSessionId] = useState<string>('');
  const [sessionHistory, setSessionHistory] = useState<Message[]>([]);

  // åˆ›å»ºæ–°ä¼šè¯
  const createNewSession = () => {
    const newSessionId = `session-${Date.now()}`;
    setCurrentSessionId(newSessionId);
    setSessionHistory([]);
    localStorage.setItem('currentSessionId', newSessionId);
    return newSessionId;
  };

  // åŠ è½½ä¼šè¯å†å²
  const loadSessionHistory = async (sessionId: string) => {
    const response = await fetch(`/api/chat?threadId=${sessionId}`);
    const data = await response.json();
    if (data.success) {
      setSessionHistory(data.data.history);
    }
  };

  return { currentSessionId, sessionHistory, createNewSession, loadSessionHistory };
}
```

---

## ğŸŒŸ å¤šä¼šè¯ç®¡ç†ç­–ç•¥

### ä¼šè¯ç”Ÿå‘½å‘¨æœŸ
- **åˆ›å»º** - ç”¨æˆ·å¼€å§‹æ–°å¯¹è¯æ—¶è‡ªåŠ¨åˆ›å»º
- **æ¿€æ´»** - ç”¨æˆ·åˆ‡æ¢åˆ°æŸä¸ªä¼šè¯
- **ä¿å­˜** - æ¯æ¬¡å¯¹è¯åè‡ªåŠ¨ä¿å­˜çŠ¶æ€
- **æ¢å¤** - é‡æ–°è®¿é—®æ—¶æ¢å¤å†å²è®°å½•

### ä¼šè¯å­˜å‚¨ç­–ç•¥
```typescript
// localStorageä¸­ä¿å­˜å½“å‰ä¼šè¯
localStorage.setItem('currentSessionId', sessionId);

// æ¢å¤æ—¶ä¼˜å…ˆä½¿ç”¨ä¿å­˜çš„ä¼šè¯ID
const savedSessionId = localStorage.getItem('currentSessionId');
if (savedSessionId) {
  setCurrentSessionId(savedSessionId);
  loadSessionHistory(savedSessionId);
}
```

---

## ğŸ”§ è°ƒè¯•å’Œä¼˜åŒ–æŠ€å·§

### çŠ¶æ€è°ƒè¯•
```typescript
const debugSessionState = async (sessionId: string) => {
  const state = await app.getState({
    configurable: { thread_id: sessionId }
  });
  
  console.log('ä¼šè¯çŠ¶æ€:', {
    sessionId,
    messageCount: state?.values?.messages?.length || 0,
    lastMessage: state?.values?.messages?.slice(-1)[0]?.content
  });
};
```

### æ€§èƒ½ä¼˜åŒ–
- **æ‡’åŠ è½½** - éœ€è¦æ—¶æ‰åŠ è½½å†å²è®°å½•
- **åˆ†é¡µå¤„ç†** - å¤§é‡å†å²æ¶ˆæ¯çš„åˆ†é¡µæ˜¾ç¤º
- **ç¼“å­˜ç­–ç•¥** - é€‚å½“ç¼“å­˜æœ€è¿‘çš„ä¼šè¯çŠ¶æ€

---

## ğŸ“‹ æ€»ç»“è¦ç‚¹

- **Threadæœºåˆ¶** - LangGraphJSçš„ä¼šè¯éš”ç¦»æœºåˆ¶
- **çŠ¶æ€æŒä¹…åŒ–** - SqliteSaverçš„è‡ªåŠ¨çŠ¶æ€ä¿å­˜
- **å†å²ç®¡ç†** - å¤šè½®å¯¹è¯çš„å®Œæ•´å†å²è®°å½•
- **å‰åç«¯åŒæ­¥** - ç¡®ä¿çŠ¶æ€åœ¨å‰åç«¯ä¿æŒä¸€è‡´
- **ç”¨æˆ·ä½“éªŒ** - æ— ç¼çš„ä¼šè¯åˆ‡æ¢å’Œå†å²æ¢å¤

å®Œå–„çš„çŠ¶æ€ç®¡ç†è®©AIåº”ç”¨æ›´å¯é ï¼

---

## ğŸš€ ä¸‹ä¸€æ­¥é¢„å‘Š

æŒæ¡äº†ä¼šè¯å’ŒçŠ¶æ€ç®¡ç†åï¼Œæˆ‘ä»¬å°†å­¦ä¹ ï¼š

**5.5 å®é™…é¡¹ç›®é›†æˆ**
- å®Œæ•´é¡¹ç›®æ¶æ„æ•´åˆ
- å‰åç«¯æ— ç¼è¿æ¥
- ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²é…ç½®
- å®Œæ•´AIèŠå¤©åº”ç”¨æ„å»º

è®©æ‰€æœ‰ç»„ä»¶å®Œç¾åä½œï¼

