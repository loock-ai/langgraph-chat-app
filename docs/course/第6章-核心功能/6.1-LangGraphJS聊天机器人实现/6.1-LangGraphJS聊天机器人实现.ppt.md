---
marp: true
theme: gaia
paginate: true
header: '6.1-LangGraphJSèŠå¤©æœºå™¨äººå®ç°'
style: |
  section {
    font-size: 30px;
  }
---

<!-- _class: lead -->
# ç¬¬6ç«  æ ¸å¿ƒåŠŸèƒ½ ğŸ”§

## 6.1 LangGraphJSèŠå¤©æœºå™¨äººå®ç°

**æ„å»ºæ™ºèƒ½å¯¹è¯çš„AIæ ¸å¿ƒ**

---

## ğŸ¯ å­¦ä¹ ç›®æ ‡

- **æ„å»ºå®Œæ•´çš„LangGraphJSèŠå¤©æœºå™¨äººæ ¸å¿ƒé€»è¾‘**
- **å®ç°StateGraphå·¥ä½œæµå’ŒchatbotèŠ‚ç‚¹**
- **é…ç½®æ£€æŸ¥ç‚¹æŒä¹…åŒ–å’Œä¼šè¯ç®¡ç†**
- **é›†æˆOpenAI APIå®ç°æ™ºèƒ½å¯¹è¯**

æ‰“é€ èŠå¤©åº”ç”¨çš„æ™ºèƒ½å¤§è„‘ï¼

---

## ğŸ“š èŠå¤©æœºå™¨äººæ¶æ„è®¾è®¡

### æ ¸å¿ƒç»„ä»¶å…³ç³»
```
StateGraph (çŠ¶æ€å›¾)
    â†“
chatbotNode (èŠå¤©èŠ‚ç‚¹) â†’ OpenAI API
    â†“
MessagesAnnotation (çŠ¶æ€ç®¡ç†)
    â†“
SqliteSaver (æ£€æŸ¥ç‚¹æŒä¹…åŒ–)
```

### å·¥ä½œæµè®¾è®¡
**START** â†’ **chatbot** â†’ **END**
- å•ä¸€èŠ‚ç‚¹è®¾è®¡ï¼Œä¸“æ³¨å¯¹è¯åŠŸèƒ½
- æ”¯æŒæµå¼å“åº”å’ŒçŠ¶æ€æŒä¹…åŒ–

---

## ğŸ’¡ chatbotèŠ‚ç‚¹æ ¸å¿ƒå®ç°

```typescript
async function chatbotNode(state: typeof MessagesAnnotation.State) {
  try {
    console.log(`å¤„ç†æ¶ˆæ¯: ${state.messages.length}æ¡å†å²æ¶ˆæ¯`);
    
    // è°ƒç”¨OpenAIæ¨¡å‹ç”Ÿæˆå›å¤
    const response = await model.invoke(state.messages);
    
    console.log(`AIå›å¤é•¿åº¦: ${response.content.length}å­—ç¬¦`);
    
    // è¿”å›æ–°çš„æ¶ˆæ¯ï¼ŒLangGraphä¼šè‡ªåŠ¨åˆå¹¶åˆ°çŠ¶æ€ä¸­
    return { messages: [response] };
    
  } catch (error) {
    console.error('chatbotèŠ‚ç‚¹å¤„ç†é”™è¯¯:', error);
    
    // è¿”å›é”™è¯¯æ¶ˆæ¯
    const errorMessage = new AIMessage('æŠ±æ­‰ï¼Œæˆ‘æš‚æ—¶æ— æ³•å›å¤ã€‚è¯·ç¨åé‡è¯•ã€‚');
    return { messages: [errorMessage] };
  }
}
```

---

## ğŸ”— StateGraphå·¥ä½œæµæ„å»º

```typescript
// åˆ›å»ºLangGraphçŠ¶æ€å›¾å·¥ä½œæµ
const workflow = new StateGraph(MessagesAnnotation)
  .addNode('chatbot', chatbotNode)
  .addEdge(START, 'chatbot')
  .addEdge('chatbot', END);

console.log('StateGraphå·¥ä½œæµåˆ›å»ºå®Œæˆ');
```

### å·¥ä½œæµç‰¹ç‚¹
- **ç®€æ´é«˜æ•ˆ** - å•èŠ‚ç‚¹è®¾è®¡ä¸“æ³¨å¯¹è¯
- **å¯æ‰©å±•** - æ˜“äºæ·»åŠ æ–°çš„èŠ‚ç‚¹å’ŒåŠŸèƒ½
- **çŠ¶æ€ç®¡ç†** - è‡ªåŠ¨å¤„ç†æ¶ˆæ¯çŠ¶æ€

---

## ğŸ”— æ£€æŸ¥ç‚¹æŒä¹…åŒ–é…ç½®

```typescript
// é…ç½®SQLiteæ£€æŸ¥ç‚¹ä¿å­˜å™¨
try {
  const checkpointer = new SqliteSaver(db);
  console.log('SQLiteæ£€æŸ¥ç‚¹ä¿å­˜å™¨åˆ›å»ºæˆåŠŸ');
  
  // ç¼–è¯‘åº”ç”¨ï¼Œæ·»åŠ æ£€æŸ¥ç‚¹æ”¯æŒ
  const app = workflow.compile({ checkpointer });
  console.log('LangGraphåº”ç”¨ç¼–è¯‘å®Œæˆï¼Œæ”¯æŒçŠ¶æ€æŒä¹…åŒ–');
  
  // å¯¼å‡ºç¼–è¯‘åçš„åº”ç”¨
  export { app, chatbotNode };
  
} catch (error) {
  console.error('æ£€æŸ¥ç‚¹é…ç½®å¤±è´¥:', error);
  throw new Error('LangGraphåº”ç”¨åˆå§‹åŒ–å¤±è´¥');
}
```

---

## ğŸŒŸ OpenAIæ¨¡å‹é…ç½®

```typescript
// app/agent/config/tools.config.ts
import { ChatOpenAI } from '@langchain/openai';

export const model = new ChatOpenAI({
  model: process.env.OPENAI_MODEL_NAME || "qwen-plus",
  temperature: 0.7,
  maxTokens: 2000,
  streaming: true,
  openAIApiKey: process.env.OPENAI_API_KEY,
});

// æ¨¡å‹é…ç½®éªŒè¯
if (!process.env.OPENAI_API_KEY) {
  throw new Error('ç¼ºå°‘OPENAI_API_KEYç¯å¢ƒå˜é‡');
}
```

åˆç†çš„æ¨¡å‹é…ç½®æ˜¯AIå¯¹è¯è´¨é‡çš„ä¿è¯ï¼

---

## ğŸ”§ é”™è¯¯å¤„ç†å’Œå®¹é”™

```typescript
async function robustChatbotNode(state: typeof MessagesAnnotation.State) {
  const maxRetries = 3;
  let lastError: any;
  
  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      const response = await model.invoke(state.messages);
      return { messages: [response] };
      
    } catch (error) {
      console.error(`chatbotèŠ‚ç‚¹é”™è¯¯ (å°è¯• ${attempt}):`, error);
      lastError = error;
      
      if (attempt < maxRetries) {
        // æŒ‡æ•°é€€é¿
        const delay = Math.pow(2, attempt) * 1000;
        await new Promise(resolve => setTimeout(resolve, delay));
      }
    }
  }
  
  // æ‰€æœ‰é‡è¯•éƒ½å¤±è´¥ï¼Œè¿”å›é”™è¯¯æ¶ˆæ¯
  const errorMessage = new AIMessage('æŠ±æ­‰ï¼ŒAIæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ã€‚è¯·ç¨åé‡è¯•ã€‚');
  return { messages: [errorMessage] };
}
```

---

## ğŸ”§ æµ‹è¯•å’ŒéªŒè¯

```typescript
// æµ‹è¯•èŠå¤©åŠŸèƒ½
export async function testChatbot() {
  const testThreadId = 'test-session-' + Date.now();
  
  try {
    console.log('å¼€å§‹æµ‹è¯•èŠå¤©æœºå™¨äºº...');
    
    // æµ‹è¯•å•è½®å¯¹è¯
    const response = await app.invoke(
      { messages: [new HumanMessage('ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹è‡ªå·±')] },
      { configurable: { thread_id: testThreadId } }
    );
    
    console.log('AIå›å¤:', response.messages[response.messages.length - 1].content);
    
    // æµ‹è¯•çŠ¶æ€æŒä¹…åŒ–
    const savedState = await app.getState({
      configurable: { thread_id: testThreadId }
    });
    
    console.log('çŠ¶æ€ä¿å­˜æˆåŠŸï¼Œæ¶ˆæ¯æ•°é‡:', savedState?.values?.messages?.length);
    
    return true;
    
  } catch (error) {
    console.error('èŠå¤©æœºå™¨äººæµ‹è¯•å¤±è´¥:', error);
    return false;
  }
}
```

---

## ğŸ“‹ æ€»ç»“è¦ç‚¹

- **StateGraphæ¶æ„** - ç®€æ´çš„å•èŠ‚ç‚¹å·¥ä½œæµè®¾è®¡
- **chatbotèŠ‚ç‚¹** - æ ¸å¿ƒçš„AIå¯¹è¯å¤„ç†é€»è¾‘
- **æ£€æŸ¥ç‚¹æŒä¹…åŒ–** - è‡ªåŠ¨çš„çŠ¶æ€ä¿å­˜å’Œæ¢å¤
- **é”™è¯¯å¤„ç†** - å¥å£®çš„å®¹é”™å’Œé‡è¯•æœºåˆ¶
- **æ¨¡å‹é›†æˆ** - OpenAI APIçš„æ·±åº¦é›†æˆ

LangGraphJSè®©AIåº”ç”¨å¼€å‘æ›´åŠ ä¸“ä¸šï¼

---

## ğŸš€ ä¸‹ä¸€æ­¥é¢„å‘Š

å®Œæˆäº†èŠå¤©æœºå™¨äººæ ¸å¿ƒå®ç°åï¼Œæˆ‘ä»¬å°†å­¦ä¹ ï¼š

**6.2 APIè·¯ç”±å®Œå–„**
- æµå¼å“åº”APIæ¥å£å®ç°
- å†å²è®°å½•è·å–å’Œä¼šè¯ç®¡ç†
- å¥å£®çš„é”™è¯¯å¤„ç†æœºåˆ¶
- ç”Ÿäº§çº§APIæ¥å£è®¾è®¡

å°†AIå¼•æ“ä¸å‰ç«¯æ— ç¼è¿æ¥ï¼

