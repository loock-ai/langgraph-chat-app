---
marp: true
theme: gaia
paginate: true
header: '7.4-ç»„ä»¶ä¼˜åŒ–'
style: |
  section {
    font-size: 30px;
  }
---

<!-- _class: lead -->
# ç¬¬7ç«  ç•Œé¢ä¼˜åŒ– ğŸ¨

## 7.4 ç»„ä»¶ä¼˜åŒ–

**æ„å»ºä¸“ä¸šçº§çš„ç»„ä»¶åº“**

---

## ğŸ¯ å­¦ä¹ ç›®æ ‡

- **æŒæ¡Reactç»„ä»¶æ€§èƒ½ä¼˜åŒ–çš„é«˜çº§æŠ€å·§**
- **å®ç°å®Œå–„çš„å¯è®¿é—®æ€§æ”¯æŒå’Œæ— éšœç¢è®¾è®¡**
- **å»ºç«‹å¯å¤ç”¨çš„ç»„ä»¶åº“å’Œè®¾è®¡ç³»ç»Ÿ**
- **ä¼˜åŒ–ç»„ä»¶çš„ç»´æŠ¤æ€§å’Œæµ‹è¯•æ€§**

è®©æ¯ä¸ªç»„ä»¶éƒ½è¾¾åˆ°ä¸“ä¸šæ°´å‡†ï¼

---

## ğŸ“š Reactæ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### æ€§èƒ½ä¼˜åŒ–æ ¸å¿ƒåŸåˆ™
- **å‡å°‘ä¸å¿…è¦çš„æ¸²æŸ“** - React.memoã€useMemoã€useCallback
- **è™šæ‹ŸåŒ–é•¿åˆ—è¡¨** - å¯¹äºå¤§é‡æ¶ˆæ¯ä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨
- **ä»£ç åˆ†å‰²** - æŒ‰éœ€åŠ è½½ç»„ä»¶å’ŒåŠŸèƒ½æ¨¡å—
- **çŠ¶æ€ç®¡ç†ä¼˜åŒ–** - åˆç†çš„çŠ¶æ€è®¾è®¡å’Œæ›´æ–°ç­–ç•¥

### ä¼˜åŒ–å·¥å…·ç®±
```typescript
// ä½¿ç”¨React.memoä¼˜åŒ–é‡æ¸²æŸ“
const MessageItem = memo(({ message, isStreaming }) => {
  return <MessageBubble message={message} isStreaming={isStreaming} />;
});

// ä½¿ç”¨useMemoä¼˜åŒ–è®¡ç®—
const itemData = useMemo(() => ({
  messages, streamingMessageId, onMessageClick
}), [messages, streamingMessageId, onMessageClick]);
```

---

## ğŸ’¡ è™šæ‹ŸåŒ–é•¿åˆ—è¡¨ä¼˜åŒ–

```typescript
import { FixedSizeList as List } from 'react-window';

const OptimizedMessageList = memo(({ messages, streamingMessageId }) => {
  const listRef = useRef();

  // è®¡ç®—æ¶ˆæ¯é¡¹é«˜åº¦
  const getItemSize = useCallback((index) => {
    const message = messages[index];
    const baseHeight = 60;
    const contentLength = message.content.length;
    const extraHeight = Math.floor(contentLength / 50) * 20;
    return Math.min(baseHeight + extraHeight, 200);
  }, [messages]);

  return (
    <List
      ref={listRef}
      height={containerHeight}
      itemCount={messages.length}
      itemSize={getItemSize}
      itemData={{ messages, streamingMessageId }}
      overscanCount={5} // é¢„æ¸²æŸ“5ä¸ªé¡¹ç›®
    >
      {MessageItem}
    </List>
  );
});
```

è™šæ‹Ÿæ»šåŠ¨è®©å¤§é‡æ¶ˆæ¯æµç•…æ˜¾ç¤ºï¼

---

## ğŸ”— æ€§èƒ½ç›‘æ§Hook

```typescript
// æ€§èƒ½ç›‘æ§å·¥å…·
export function usePerformanceMonitor(componentName) {
  const renderStartTime = useRef(0);
  const renderCount = useRef(0);

  useEffect(() => {
    renderStartTime.current = performance.now();
  });

  useEffect(() => {
    const renderTime = performance.now() - renderStartTime.current;
    renderCount.current += 1;

    // è®°å½•æ€§èƒ½æŒ‡æ ‡
    if (renderTime > 16) { // è¶…è¿‡ä¸€å¸§æ—¶é—´
      console.warn(`${componentName} æ¸²æŸ“æ—¶é—´è¿‡é•¿:`, {
        renderTime: `${renderTime.toFixed(2)}ms`,
        renderCount: renderCount.current
      });
    }
  });

  return { renderCount: renderCount.current };
}

// ä½¿ç”¨ç¤ºä¾‹
function MyComponent() {
  usePerformanceMonitor('MessageList');
  return <div>...</div>;
}
```

---

## ğŸŒŸ å¯è®¿é—®æ€§å¢å¼º

```typescript
export function AccessibleChatInterface({ messages, onSendMessage, isLoading }) {
  const [announceText, setAnnounceText] = useState('');

  // å±å¹•é˜…è¯»å™¨å…¬å‘Š
  const announceToScreenReader = (text) => {
    setAnnounceText(text);
    setTimeout(() => setAnnounceText(''), 1000);
  };

  return (
    <div className="flex flex-col h-full">
      {/* å±å¹•é˜…è¯»å™¨å…¬å‘ŠåŒºåŸŸ */}
      <div aria-live="polite" aria-atomic="true" className="sr-only" role="status">
        {announceText}
      </div>

      {/* æ¶ˆæ¯åˆ—è¡¨ */}
      <main className="flex-1 overflow-y-auto" role="log" aria-label="èŠå¤©æ¶ˆæ¯" aria-live="polite">
        {messages.map((message, index) => (
          <div
            key={message.id}
            role="article"
            aria-labelledby={`message-${index}-label`}
            tabIndex={0}
          >
            <span id={`message-${index}-label`} className="sr-only">
              {message.role === 'user' ? 'æ‚¨çš„æ¶ˆæ¯' : 'AIå›å¤'}ï¼Œ
              å‘é€æ—¶é—´ {new Date(message.timestamp).toLocaleString()}
            </span>
            <div role="text">{message.content}</div>
          </div>
        ))}
      </main>

      {/* è¾“å…¥åŒºåŸŸ */}
      <form role="region" aria-label="æ¶ˆæ¯è¾“å…¥åŒºåŸŸ">
        <label htmlFor="message-input" className="sr-only">è¾“å…¥æ‚¨çš„æ¶ˆæ¯</label>
        <textarea
          id="message-input"
          aria-describedby="input-help"
          maxLength={1000}
        />
        <p id="input-help">æŒ‰ Enter å‘é€æ¶ˆæ¯ï¼Œæœ€å¤š 1000 å­—ç¬¦</p>
      </form>
    </div>
  );
}
```

---

## ğŸ”— å¯å¤ç”¨ç»„ä»¶åº“

```typescript
// ä½¿ç”¨class-variance-authorityåˆ›å»ºå˜ä½“ç»„ä»¶
import { cva, type VariantProps } from 'class-variance-authority';

const buttonVariants = cva(
  'inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors',
  {
    variants: {
      variant: {
        default: 'bg-primary text-primary-foreground hover:bg-primary/90',
        destructive: 'bg-destructive text-destructive-foreground hover:bg-destructive/90',
        outline: 'border border-input bg-background hover:bg-accent',
        ghost: 'hover:bg-accent hover:text-accent-foreground',
      },
      size: {
        default: 'h-10 px-4 py-2',
        sm: 'h-9 rounded-md px-3',
        lg: 'h-11 rounded-md px-8',
        icon: 'h-10 w-10',
      },
    },
    defaultVariants: {
      variant: 'default',
      size: 'default',
    },
  }
);

export interface ButtonProps extends VariantProps<typeof buttonVariants> {
  children: React.ReactNode;
}

const Button = forwardRef<HTMLButtonElement, ButtonProps>(
  ({ className, variant, size, ...props }, ref) => {
    return (
      <button
        className={cn(buttonVariants({ variant, size, className }))}
        ref={ref}
        {...props}
      />
    );
  }
);
```

---

## ğŸ”— çŠ¶æ€ç®¡ç†ä¼˜åŒ–

```typescript
// ä¼˜åŒ–çš„èŠå¤©çŠ¶æ€ç®¡ç†
export function useOptimizedChatState(initialSessionId) {
  const [state, dispatch] = useReducer(chatReducer, {
    messages: [],
    streamingMessageId: null,
    isLoading: false,
    error: null,
    sessionId: initialSessionId
  });

  // ä¼˜åŒ–çš„åŠ¨ä½œåˆ›å»ºå™¨
  const actions = useMemo(() => ({
    addMessage: (message) => dispatch({ type: 'ADD_MESSAGE', payload: message }),
    updateStreamingMessage: (id, content) => 
      dispatch({ type: 'UPDATE_STREAMING_MESSAGE', payload: { id, content } }),
    finishStreaming: (id) => dispatch({ type: 'FINISH_STREAMING', payload: id }),
    setLoading: (loading) => dispatch({ type: 'SET_LOADING', payload: loading }),
  }), []);

  // æ´¾ç”ŸçŠ¶æ€
  const derivedState = useMemo(() => ({
    hasMessages: state.messages.length > 0,
    lastMessage: state.messages[state.messages.length - 1],
    messageCount: state.messages.length,
    isStreaming: !!state.streamingMessageId
  }), [state.messages, state.streamingMessageId]);

  return { ...state, ...derivedState, ...actions };
}
```

---

## ğŸ”§ ç»„ä»¶æµ‹è¯•ç­–ç•¥

```typescript
// å®Œæ•´çš„ç»„ä»¶æµ‹è¯•ç¤ºä¾‹
describe('Button Component', () => {
  it('renders correctly', () => {
    render(<Button>Click me</Button>);
    expect(screen.getByRole('button')).toBeInTheDocument();
    expect(screen.getByText('Click me')).toBeInTheDocument();
  });

  it('handles click events', () => {
    const handleClick = jest.fn();
    render(<Button onClick={handleClick}>Click me</Button>);
    
    fireEvent.click(screen.getByRole('button'));
    expect(handleClick).toHaveBeenCalledTimes(1);
  });

  it('applies variant styles correctly', () => {
    render(<Button variant="destructive">Delete</Button>);
    const button = screen.getByRole('button');
    expect(button).toHaveClass('bg-destructive');
  });

  it('supports disabled state', () => {
    render(<Button disabled>Disabled</Button>);
    const button = screen.getByRole('button');
    expect(button).toBeDisabled();
  });

  it('supports accessibility features', () => {
    render(<Button aria-label="Custom label">Icon</Button>);
    expect(screen.getByLabelText('Custom label')).toBeInTheDocument();
  });
});
```

---

## ğŸ”§ ä»£ç è´¨é‡ä¿è¯

### ESLinté…ç½®ä¼˜åŒ–
```json
{
  "extends": [
    "next/core-web-vitals",
    "@typescript-eslint/recommended",
    "prettier"
  ],
  "plugins": ["@typescript-eslint", "jsx-a11y"],
  "rules": {
    "jsx-a11y/alt-text": "error",
    "jsx-a11y/aria-props": "error",
    "jsx-a11y/role-has-required-aria-props": "error",
    "@typescript-eslint/no-unused-vars": "error",
    "@typescript-eslint/explicit-function-return-type": "warn"
  }
}
```

### æµ‹è¯•è¦†ç›–ç‡è¦æ±‚
```javascript
// jest.config.js
module.exports = {
  coverageThreshold: {
    global: {
      branches: 80,
      functions: 80,
      lines: 80,
      statements: 80,
    },
  },
};
```

---

## ğŸ“‹ æ€»ç»“è¦ç‚¹

- **æ€§èƒ½ä¼˜åŒ–** - React.memoã€è™šæ‹Ÿæ»šåŠ¨ã€ä»£ç åˆ†å‰²
- **å¯è®¿é—®æ€§** - ARIAå±æ€§ã€é”®ç›˜å¯¼èˆªã€å±å¹•é˜…è¯»å™¨æ”¯æŒ
- **ç»„ä»¶åº“** - å¯å¤ç”¨çš„è®¾è®¡ç³»ç»Ÿå’Œç»„ä»¶æ¶æ„
- **æµ‹è¯•ç­–ç•¥** - å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ã€å¯è®¿é—®æ€§æµ‹è¯•
- **ä»£ç è´¨é‡** - TypeScriptã€ESLintã€ä»£ç è¦†ç›–ç‡

ä¸“ä¸šçš„ç»„ä»¶è®©å¼€å‘æ›´é«˜æ•ˆï¼

---

## ğŸš€ ç¬¬7ç« æ€»ç»“

æ­å–œå®Œæˆç¬¬7ç« ç•Œé¢ä¼˜åŒ–çš„å­¦ä¹ ï¼æ‚¨ç°åœ¨å·²ç»æŒæ¡äº†ï¼š

### âœ… å®Œæˆçš„æŠ€èƒ½
- **ç°ä»£UIè®¾è®¡** - ä¸“ä¸šçº§çš„ç•Œé¢è®¾è®¡èƒ½åŠ›
- **Tailwind CSSç²¾é€š** - é«˜æ•ˆçš„æ ·å¼å¼€å‘æŠ€èƒ½
- **äº¤äº’è®¾è®¡** - ä¸°å¯Œçš„ç”¨æˆ·äº¤äº’å®ç°
- **ç»„ä»¶å·¥ç¨‹åŒ–** - å¯ç»´æŠ¤çš„ç»„ä»¶æ¶æ„

### ğŸŒŸ ä¸‹ä¸€æ­¥æ–¹å‘
**ç¬¬8ç« ï¼šé«˜çº§ç‰¹æ€§** - å¤šä¼šè¯ç®¡ç†ã€æ•°æ®å¯¼å‡ºç­‰åŠŸèƒ½

æ‚¨çš„UI/UXè®¾è®¡å’Œå¼€å‘æŠ€èƒ½å·²ç»è¾¾åˆ°ä¸“ä¸šæ°´å‡†ï¼

