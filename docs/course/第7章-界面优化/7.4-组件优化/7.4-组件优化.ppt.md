---
marp: true
theme: gaia
paginate: true
header: '7.4-组件优化'
style: |
  section {
    font-size: 30px;
  }
---

<!-- _class: lead -->
# 第7章 界面优化 🎨

## 7.4 组件优化

**构建专业级的组件库**

---

## 🎯 学习目标

- **掌握React组件性能优化的高级技巧**
- **实现完善的可访问性支持和无障碍设计**
- **建立可复用的组件库和设计系统**
- **优化组件的维护性和测试性**

让每个组件都达到专业水准！

---

## 📚 React性能优化策略

### 性能优化核心原则
- **减少不必要的渲染** - React.memo、useMemo、useCallback
- **虚拟化长列表** - 对于大量消息使用虚拟滚动
- **代码分割** - 按需加载组件和功能模块
- **状态管理优化** - 合理的状态设计和更新策略

### 优化工具箱
```typescript
// 使用React.memo优化重渲染
const MessageItem = memo(({ message, isStreaming }) => {
  return <MessageBubble message={message} isStreaming={isStreaming} />;
});

// 使用useMemo优化计算
const itemData = useMemo(() => ({
  messages, streamingMessageId, onMessageClick
}), [messages, streamingMessageId, onMessageClick]);
```

---

## 💡 虚拟化长列表优化

```typescript
import { FixedSizeList as List } from 'react-window';

const OptimizedMessageList = memo(({ messages, streamingMessageId }) => {
  const listRef = useRef();

  // 计算消息项高度
  const getItemSize = useCallback((index) => {
    const message = messages[index];
    const baseHeight = 60;
    const contentLength = message.content.length;
    const extraHeight = Math.floor(contentLength / 50) * 20;
    return Math.min(baseHeight + extraHeight, 200);
  }, [messages]);

  return (
    <List
      ref={listRef}
      height={containerHeight}
      itemCount={messages.length}
      itemSize={getItemSize}
      itemData={{ messages, streamingMessageId }}
      overscanCount={5} // 预渲染5个项目
    >
      {MessageItem}
    </List>
  );
});
```

虚拟滚动让大量消息流畅显示！

---

## 🔗 性能监控Hook

```typescript
// 性能监控工具
export function usePerformanceMonitor(componentName) {
  const renderStartTime = useRef(0);
  const renderCount = useRef(0);

  useEffect(() => {
    renderStartTime.current = performance.now();
  });

  useEffect(() => {
    const renderTime = performance.now() - renderStartTime.current;
    renderCount.current += 1;

    // 记录性能指标
    if (renderTime > 16) { // 超过一帧时间
      console.warn(`${componentName} 渲染时间过长:`, {
        renderTime: `${renderTime.toFixed(2)}ms`,
        renderCount: renderCount.current
      });
    }
  });

  return { renderCount: renderCount.current };
}

// 使用示例
function MyComponent() {
  usePerformanceMonitor('MessageList');
  return <div>...</div>;
}
```

---

## 🌟 可访问性增强

```typescript
export function AccessibleChatInterface({ messages, onSendMessage, isLoading }) {
  const [announceText, setAnnounceText] = useState('');

  // 屏幕阅读器公告
  const announceToScreenReader = (text) => {
    setAnnounceText(text);
    setTimeout(() => setAnnounceText(''), 1000);
  };

  return (
    <div className="flex flex-col h-full">
      {/* 屏幕阅读器公告区域 */}
      <div aria-live="polite" aria-atomic="true" className="sr-only" role="status">
        {announceText}
      </div>

      {/* 消息列表 */}
      <main className="flex-1 overflow-y-auto" role="log" aria-label="聊天消息" aria-live="polite">
        {messages.map((message, index) => (
          <div
            key={message.id}
            role="article"
            aria-labelledby={`message-${index}-label`}
            tabIndex={0}
          >
            <span id={`message-${index}-label`} className="sr-only">
              {message.role === 'user' ? '您的消息' : 'AI回复'}，
              发送时间 {new Date(message.timestamp).toLocaleString()}
            </span>
            <div role="text">{message.content}</div>
          </div>
        ))}
      </main>

      {/* 输入区域 */}
      <form role="region" aria-label="消息输入区域">
        <label htmlFor="message-input" className="sr-only">输入您的消息</label>
        <textarea
          id="message-input"
          aria-describedby="input-help"
          maxLength={1000}
        />
        <p id="input-help">按 Enter 发送消息，最多 1000 字符</p>
      </form>
    </div>
  );
}
```

---

## 🔗 可复用组件库

```typescript
// 使用class-variance-authority创建变体组件
import { cva, type VariantProps } from 'class-variance-authority';

const buttonVariants = cva(
  'inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors',
  {
    variants: {
      variant: {
        default: 'bg-primary text-primary-foreground hover:bg-primary/90',
        destructive: 'bg-destructive text-destructive-foreground hover:bg-destructive/90',
        outline: 'border border-input bg-background hover:bg-accent',
        ghost: 'hover:bg-accent hover:text-accent-foreground',
      },
      size: {
        default: 'h-10 px-4 py-2',
        sm: 'h-9 rounded-md px-3',
        lg: 'h-11 rounded-md px-8',
        icon: 'h-10 w-10',
      },
    },
    defaultVariants: {
      variant: 'default',
      size: 'default',
    },
  }
);

export interface ButtonProps extends VariantProps<typeof buttonVariants> {
  children: React.ReactNode;
}

const Button = forwardRef<HTMLButtonElement, ButtonProps>(
  ({ className, variant, size, ...props }, ref) => {
    return (
      <button
        className={cn(buttonVariants({ variant, size, className }))}
        ref={ref}
        {...props}
      />
    );
  }
);
```

---

## 🔗 状态管理优化

```typescript
// 优化的聊天状态管理
export function useOptimizedChatState(initialSessionId) {
  const [state, dispatch] = useReducer(chatReducer, {
    messages: [],
    streamingMessageId: null,
    isLoading: false,
    error: null,
    sessionId: initialSessionId
  });

  // 优化的动作创建器
  const actions = useMemo(() => ({
    addMessage: (message) => dispatch({ type: 'ADD_MESSAGE', payload: message }),
    updateStreamingMessage: (id, content) => 
      dispatch({ type: 'UPDATE_STREAMING_MESSAGE', payload: { id, content } }),
    finishStreaming: (id) => dispatch({ type: 'FINISH_STREAMING', payload: id }),
    setLoading: (loading) => dispatch({ type: 'SET_LOADING', payload: loading }),
  }), []);

  // 派生状态
  const derivedState = useMemo(() => ({
    hasMessages: state.messages.length > 0,
    lastMessage: state.messages[state.messages.length - 1],
    messageCount: state.messages.length,
    isStreaming: !!state.streamingMessageId
  }), [state.messages, state.streamingMessageId]);

  return { ...state, ...derivedState, ...actions };
}
```

---

## 🔧 组件测试策略

```typescript
// 完整的组件测试示例
describe('Button Component', () => {
  it('renders correctly', () => {
    render(<Button>Click me</Button>);
    expect(screen.getByRole('button')).toBeInTheDocument();
    expect(screen.getByText('Click me')).toBeInTheDocument();
  });

  it('handles click events', () => {
    const handleClick = jest.fn();
    render(<Button onClick={handleClick}>Click me</Button>);
    
    fireEvent.click(screen.getByRole('button'));
    expect(handleClick).toHaveBeenCalledTimes(1);
  });

  it('applies variant styles correctly', () => {
    render(<Button variant="destructive">Delete</Button>);
    const button = screen.getByRole('button');
    expect(button).toHaveClass('bg-destructive');
  });

  it('supports disabled state', () => {
    render(<Button disabled>Disabled</Button>);
    const button = screen.getByRole('button');
    expect(button).toBeDisabled();
  });

  it('supports accessibility features', () => {
    render(<Button aria-label="Custom label">Icon</Button>);
    expect(screen.getByLabelText('Custom label')).toBeInTheDocument();
  });
});
```

---

## 🔧 代码质量保证

### ESLint配置优化
```json
{
  "extends": [
    "next/core-web-vitals",
    "@typescript-eslint/recommended",
    "prettier"
  ],
  "plugins": ["@typescript-eslint", "jsx-a11y"],
  "rules": {
    "jsx-a11y/alt-text": "error",
    "jsx-a11y/aria-props": "error",
    "jsx-a11y/role-has-required-aria-props": "error",
    "@typescript-eslint/no-unused-vars": "error",
    "@typescript-eslint/explicit-function-return-type": "warn"
  }
}
```

### 测试覆盖率要求
```javascript
// jest.config.js
module.exports = {
  coverageThreshold: {
    global: {
      branches: 80,
      functions: 80,
      lines: 80,
      statements: 80,
    },
  },
};
```

---

## 📋 总结要点

- **性能优化** - React.memo、虚拟滚动、代码分割
- **可访问性** - ARIA属性、键盘导航、屏幕阅读器支持
- **组件库** - 可复用的设计系统和组件架构
- **测试策略** - 单元测试、集成测试、可访问性测试
- **代码质量** - TypeScript、ESLint、代码覆盖率

专业的组件让开发更高效！

---

## 🚀 第7章总结

恭喜完成第7章界面优化的学习！您现在已经掌握了：

### ✅ 完成的技能
- **现代UI设计** - 专业级的界面设计能力
- **Tailwind CSS精通** - 高效的样式开发技能
- **交互设计** - 丰富的用户交互实现
- **组件工程化** - 可维护的组件架构

### 🌟 下一步方向
**第8章：高级特性** - 多会话管理、数据导出等功能

您的UI/UX设计和开发技能已经达到专业水准！

