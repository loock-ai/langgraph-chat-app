---
marp: true
theme: gaia
paginate: true
header: '8.2-SessionSidebarç»„ä»¶å®ç°'
style: |
  section {
    font-size: 30px;
  }
---

<!-- _class: lead -->
# 8.2 SessionSidebarç»„ä»¶å®ç° ğŸ¨

## æ„å»ºé«˜è´¨é‡çš„ä¼šè¯ä¾§è¾¹æ ç»„ä»¶

**ç¬¬8ç« ï¼šé«˜çº§ç‰¹æ€§**

---

## ğŸ¯ å­¦ä¹ ç›®æ ‡

å®Œæˆæœ¬èŠ‚å­¦ä¹ åï¼Œæ‚¨å°†èƒ½å¤Ÿï¼š

- **è®¾è®¡ç°ä»£åŒ–çš„Reactç»„ä»¶æ¶æ„**ï¼šæŒæ¡ç»„ä»¶æ‹†åˆ†ã€Propsè®¾è®¡å’ŒçŠ¶æ€ç®¡ç†
- **å®ç°å¤æ‚çš„ç”¨æˆ·äº¤äº’é€»è¾‘**ï¼šå¤„ç†ä¼šè¯åˆ‡æ¢ã€é‡å‘½åã€åˆ é™¤ç­‰æ“ä½œ
- **ä¼˜åŒ–ç»„ä»¶æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒ**ï¼šä½¿ç”¨Reactä¼˜åŒ–æŠ€å·§å’Œæµç•…çš„åŠ¨ç”»æ•ˆæœ
- **é›†æˆAPIæ•°æ®å’ŒçŠ¶æ€åŒæ­¥**ï¼šå¤„ç†å¼‚æ­¥æ•°æ®è·å–å’Œç»„ä»¶çŠ¶æ€æ›´æ–°
- **æ„å»ºå¯å¤ç”¨çš„UIç»„ä»¶**ï¼šå»ºç«‹ç»„ä»¶è®¾è®¡æ¨¡å¼å’Œæœ€ä½³å®è·µ

---

## ğŸ—ï¸ ç»„ä»¶æ¶æ„è®¾è®¡

### ç»„ä»¶å±‚æ¬¡ç»“æ„
```
SessionSidebar (ä¸»ç»„ä»¶)
â”œâ”€â”€ SidebarHeader (å¤´éƒ¨åŒºåŸŸ)
â”‚   â”œâ”€â”€ æ–°å»ºä¼šè¯æŒ‰é’®
â”‚   â””â”€â”€ æœç´¢æ¡†
â”œâ”€â”€ SessionList (ä¼šè¯åˆ—è¡¨)
â”‚   â””â”€â”€ SessionItem[] (ä¼šè¯é¡¹æ•°ç»„)
â”‚       â”œâ”€â”€ SessionIcon (ä¼šè¯å›¾æ ‡)
â”‚       â”œâ”€â”€ SessionName (ä¼šè¯åç§°)
â”‚       â””â”€â”€ SessionActions (æ“ä½œæŒ‰é’®)
â””â”€â”€ SidebarFooter (åº•éƒ¨åŒºåŸŸ)
```

### Propsæ¥å£è®¾è®¡
```typescript
interface SessionSidebarProps {
  currentSessionId: string;
  onSelect: (sessionId: string) => void;
  onNew: (sessionId: string) => void;
  onDelete?: (sessionId: string) => void;
  onRename?: (sessionId: string, newName: string) => void;
  className?: string;
  isCollapsed?: boolean;
}
```

---

## ğŸ¨ ä¸»ç»„ä»¶å®ç°

### æ ¸å¿ƒçŠ¶æ€ç®¡ç†
```typescript
const SessionSidebar = forwardRef<HTMLDivElement, SessionSidebarProps>(
  function SessionSidebar({ currentSessionId, onSelect, onNew }, ref) {
    const [state, setState] = useState({
      sessions: [],
      loading: true,
      error: null,
      editingId: null,
      editingName: ''
    });

    const updateState = useCallback((updates) => {
      setState(prev => ({ ...prev, ...updates }));
    }, []);

    // ç»„ä»¶å®ç°...
  }
);
```

### æ•°æ®è·å–å’Œç®¡ç†
```typescript
const fetchSessions = useCallback(async () => {
  try {
    updateState({ loading: true, error: null });
    
    const response = await fetch('/api/chat/sessions');
    const data = await response.json();
    
    if (Array.isArray(data.sessions)) {
      updateState({ sessions: data.sessions, loading: false });
    }
  } catch (error) {
    updateState({ 
      error: 'è·å–ä¼šè¯åˆ—è¡¨å¤±è´¥',
      loading: false 
    });
  }
}, [updateState]);
```

---

## ğŸ”„ ä¼šè¯æ“ä½œåŠŸèƒ½

### åˆ›å»ºæ–°ä¼šè¯
```typescript
const handleCreateSession = useCallback(async () => {
  try {
    updateState({ loading: true });
    
    const response = await fetch('/api/chat/sessions', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name: '' })
    });
    
    const newSession = await response.json();
    onNew(newSession.id);
    await fetchSessions();
  } catch (error) {
    updateState({ 
      error: 'åˆ›å»ºä¼šè¯å¤±è´¥',
      loading: false 
    });
  }
}, [onNew, fetchSessions, updateState]);
```

### ä¼šè¯é‡å‘½åå¤„ç†
```typescript
const handleSaveEdit = useCallback(async () => {
  if (!editingId || !editingName.trim()) return;

  try {
    const response = await fetch('/api/chat/sessions', {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        id: editingId, 
        name: editingName.trim(),
        action: 'rename'
      })
    });

    if (response.ok) {
      // æ›´æ–°æœ¬åœ°çŠ¶æ€
      updateState({
        sessions: sessions.map(session =>
          session.id === editingId
            ? { ...session, name: editingName.trim() }
            : session
        ),
        editingId: null,
        editingName: ''
      });
    }
  } catch (error) {
    updateState({ error: 'é‡å‘½åå¤±è´¥' });
  }
}, [editingId, editingName, sessions, updateState]);
```

---

## ğŸ¨ å­ç»„ä»¶å®ç°

### SidebarHeaderç»„ä»¶
```typescript
const SidebarHeader = ({ isCollapsed, onCreateSession, loading }) => (
  <div className="p-4 border-b border-gray-700">
    <div className="flex items-center justify-between">
      {!isCollapsed && (
        <h2 className="text-lg font-semibold text-white">
          ä¼šè¯å†å²
        </h2>
      )}
      
      <button
        onClick={onCreateSession}
        disabled={loading}
        className="p-2 text-gray-400 hover:text-white hover:bg-gray-800 
                   rounded-lg transition-colors"
        title="æ–°å»ºä¼šè¯"
      >
        <PlusIcon className="w-5 h-5" />
      </button>
    </div>
    
    {!isCollapsed && (
      <SearchInput placeholder="æœç´¢ä¼šè¯..." />
    )}
  </div>
);
```

### SessionItemç»„ä»¶
```typescript
const SessionItem = ({ 
  session, isActive, isEditing, editingName,
  onSelect, onStartEdit, onSaveEdit, onEditNameChange 
}) => {
  const itemClasses = `
    group relative px-3 py-2 mx-2 rounded-lg cursor-pointer 
    transition-all duration-200
    ${isActive ? 'bg-blue-600 text-white' : 'text-gray-300 hover:bg-gray-800'}
  `;

  return (
    <div className={itemClasses} onClick={!isEditing ? onSelect : undefined}>
      <div className="flex items-center">
        <ChatBubbleLeftIcon className="w-5 h-5 flex-shrink-0" />
        
        <div className="flex-1 ml-3 min-w-0">
          {isEditing ? (
            <input
              type="text"
              value={editingName}
              onChange={(e) => onEditNameChange(e.target.value)}
              onKeyDown={(e) => e.key === 'Enter' && onSaveEdit()}
              className="w-full px-2 py-1 text-sm bg-gray-700 
                         border border-gray-600 rounded"
              autoFocus
            />
          ) : (
            <div className="text-sm font-medium truncate">
              {session.name}
            </div>
          )}
        </div>
      </div>
    </div>
  );
};
```

---

## âš¡ æ€§èƒ½ä¼˜åŒ–æŠ€å·§

### React.memoä¼˜åŒ–
```typescript
const SessionItem = React.memo(({ 
  session, isActive, isEditing 
}) => {
  // ç»„ä»¶å®ç°...
}, (prevProps, nextProps) => {
  // è‡ªå®šä¹‰æ¯”è¾ƒå‡½æ•°
  return (
    prevProps.session.id === nextProps.session.id &&
    prevProps.session.name === nextProps.session.name &&
    prevProps.isActive === nextProps.isActive &&
    prevProps.isEditing === nextProps.isEditing
  );
});
```

### useMemoä¼˜åŒ–è®¡ç®—
```typescript
const SessionSidebar = (props) => {
  // ç¼“å­˜è¿‡æ»¤åçš„ä¼šè¯åˆ—è¡¨
  const filteredSessions = useMemo(() => {
    if (!searchQuery) return sessions;
    
    return sessions.filter(session =>
      session.name.toLowerCase().includes(searchQuery.toLowerCase())
    );
  }, [sessions, searchQuery]);

  // ç¼“å­˜æ ·å¼è®¡ç®—
  const sidebarStyles = useMemo(() => ({
    width: isCollapsed ? '64px' : '320px',
    transition: 'width 0.3s ease-in-out'
  }), [isCollapsed]);
  
  // ç»„ä»¶å®ç°...
};
```

---

## ğŸª äº¤äº’å¢å¼ºåŠŸèƒ½

### åˆ é™¤ç¡®è®¤å¼¹çª—
```typescript
const DeleteConfirmModal = ({ sessionName, onConfirm, onCancel }) => (
  <div className="fixed inset-0 bg-black bg-opacity-50 z-50 
                  flex items-center justify-center">
    <div className="bg-gray-800 border border-gray-600 rounded-lg p-6 max-w-sm">
      <h3 className="text-lg font-semibold text-white mb-2">
        ç¡®è®¤åˆ é™¤
      </h3>
      <p className="text-gray-300 mb-4">
        ç¡®å®šè¦åˆ é™¤ä¼šè¯ "<span className="font-medium">{sessionName}</span>" å—ï¼Ÿ
      </p>
      <div className="flex space-x-3">
        <button
          onClick={onCancel}
          className="flex-1 px-4 py-2 text-gray-300 bg-gray-700 
                     hover:bg-gray-600 rounded-lg transition-colors"
        >
          å–æ¶ˆ
        </button>
        <button
          onClick={onConfirm}
          className="flex-1 px-4 py-2 text-white bg-red-600 
                     hover:bg-red-700 rounded-lg transition-colors"
        >
          åˆ é™¤
        </button>
      </div>
    </div>
  </div>
);
```

### æ“ä½œèœå•ç»„ä»¶
```typescript
const SessionActions = ({ onEdit, onDelete }) => {
  const [showMenu, setShowMenu] = useState(false);

  return (
    <div className="relative">
      <button
        onClick={(e) => {
          e.stopPropagation();
          setShowMenu(!showMenu);
        }}
        className="p-1 text-gray-400 hover:text-white hover:bg-gray-700 
                   rounded opacity-0 group-hover:opacity-100 transition-all"
      >
        <EllipsisVerticalIcon className="w-4 h-4" />
      </button>

      {showMenu && (
        <div className="absolute right-0 top-full mt-1 w-32 bg-gray-800 
                        border border-gray-600 rounded-lg shadow-lg z-20">
          <button onClick={onEdit} className="menu-item">é‡å‘½å</button>
          <button onClick={onDelete} className="menu-item text-red-400">åˆ é™¤</button>
        </div>
      )}
    </div>
  );
};
```

---

## ğŸ” æœç´¢åŠŸèƒ½å®ç°

### æœç´¢è¾“å…¥ç»„ä»¶
```typescript
const SearchInput = ({ placeholder, onSearch }) => {
  const [query, setQuery] = useState('');
  const [isFocused, setIsFocused] = useState(false);

  const handleChange = (e) => {
    const value = e.target.value;
    setQuery(value);
    onSearch?.(value);
  };

  return (
    <div className="relative mt-3">
      <input
        type="text"
        value={query}
        onChange={handleChange}
        onFocus={() => setIsFocused(true)}
        onBlur={() => setIsFocused(false)}
        placeholder={placeholder}
        className="w-full px-3 py-2 pl-9 text-sm bg-gray-800 
                   border border-gray-600 rounded-lg 
                   focus:outline-none focus:border-blue-500"
      />
      <SearchIcon className="absolute left-3 top-2.5 w-4 h-4 text-gray-500" />
    </div>
  );
};
```

### é˜²æŠ–æœç´¢ä¼˜åŒ–
```typescript
const useDebounceSearch = (onSearch, delay = 300) => {
  const timeoutRef = useRef();

  return useCallback((query) => {
    if (timeoutRef.current) {
      clearTimeout(timeoutRef.current);
    }
    
    timeoutRef.current = setTimeout(() => {
      onSearch(query);
    }, delay);
  }, [onSearch, delay]);
};
```

---

## ğŸ“± å“åº”å¼è®¾è®¡

### ç§»åŠ¨ç«¯é€‚é…
```typescript
const ResponsiveSidebar = ({ isOpen, onClose, children }) => {
  const breakpoint = useBreakpoint();
  const isOverlay = breakpoint.isBelow('lg');

  if (isOverlay) {
    return (
      <AnimatePresence>
        {isOpen && (
          <>
            {/* é®ç½©å±‚ */}
            <motion.div
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              exit={{ opacity: 0 }}
              onClick={onClose}
              className="fixed inset-0 bg-black bg-opacity-50 z-40"
            />
            
            {/* ä¾§è¾¹æ  */}
            <motion.div
              initial={{ x: '-100%' }}
              animate={{ x: 0 }}
              exit={{ x: '-100%' }}
              className="fixed left-0 top-0 h-full w-80 bg-white 
                         dark:bg-gray-900 shadow-xl z-50"
            >
              {children}
            </motion.div>
          </>
        )}
      </AnimatePresence>
    );
  }

  return <div className="hidden lg:flex lg:w-80">{children}</div>;
};
```

---

## ğŸ­ åŠ¨ç”»æ•ˆæœå®ç°

### ä¼šè¯é¡¹åŠ¨ç”»
```typescript
const AnimatedSessionItem = (props) => (
  <motion.div
    initial={{ opacity: 0, x: -20 }}
    animate={{ opacity: 1, x: 0 }}
    exit={{ opacity: 0, x: -20 }}
    transition={{ duration: 0.2 }}
    whileHover={{ x: 4 }}
    whileTap={{ scale: 0.98 }}
  >
    <SessionItem {...props} />
  </motion.div>
);
```

### åˆ—è¡¨åŠ¨ç”»å®¹å™¨
```typescript
const AnimatedSessionList = ({ sessions }) => (
  <AnimatePresence mode="popLayout">
    {sessions.map((session, index) => (
      <motion.div
        key={session.id}
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        exit={{ opacity: 0, y: -20 }}
        transition={{ 
          duration: 0.2, 
          delay: index * 0.05 
        }}
      >
        <SessionItem session={session} />
      </motion.div>
    ))}
  </AnimatePresence>
);
```

---

## ğŸš€ è™šæ‹Ÿæ»šåŠ¨ä¼˜åŒ–

### å¤§æ•°æ®é‡å¤„ç†
```typescript
import { FixedSizeList as List } from 'react-window';

const VirtualSessionList = ({ sessions, height }) => {
  const Row = useCallback(({ index, style }) => {
    const session = sessions[index];
    
    return (
      <div style={style}>
        <SessionItem
          session={session}
          isActive={session.id === currentSessionId}
          // ...å…¶ä»–props
        />
      </div>
    );
  }, [sessions, currentSessionId]);

  return (
    <List
      height={height}
      itemCount={sessions.length}
      itemSize={60} // æ¯é¡¹é«˜åº¦
      width="100%"
      overscanCount={5} // é¢„æ¸²æŸ“é¡¹ç›®æ•°
    >
      {Row}
    </List>
  );
};
```

---

## ğŸ§ª ç»„ä»¶æµ‹è¯•

### å•å…ƒæµ‹è¯•ç¤ºä¾‹
```typescript
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import SessionSidebar from '../SessionSidebar';

describe('SessionSidebar', () => {
  const mockProps = {
    currentSessionId: 'session-1',
    onSelect: jest.fn(),
    onNew: jest.fn()
  };

  test('renders session list correctly', async () => {
    global.fetch = jest.fn().mockResolvedValue({
      ok: true,
      json: async () => ({
        sessions: [
          { id: 'session-1', name: 'ä¼šè¯1', createdAt: '2024-01-01' }
        ]
      })
    });

    render(<SessionSidebar {...mockProps} />);
    
    await waitFor(() => {
      expect(screen.getByText('ä¼šè¯1')).toBeInTheDocument();
    });
  });

  test('handles new session creation', async () => {
    // æµ‹è¯•æ–°å»ºä¼šè¯åŠŸèƒ½...
  });
});
```

---

## ğŸ›ï¸ çŠ¶æ€ç®¡ç†æœ€ä½³å®è·µ

### çŠ¶æ€ç»“æ„è®¾è®¡
```typescript
interface SessionSidebarState {
  // æ•°æ®çŠ¶æ€
  sessions: Session[];
  loading: boolean;
  error: string | null;
  
  // äº¤äº’çŠ¶æ€
  editingId: string | null;
  editingName: string;
  showDeleteConfirm: string | null;
  
  // UIçŠ¶æ€
  searchQuery: string;
  isCollapsed: boolean;
}
```

### çŠ¶æ€æ›´æ–°æ¨¡å¼
```typescript
// ä½¿ç”¨reduceræ¨¡å¼ç®¡ç†å¤æ‚çŠ¶æ€
const sessionSidebarReducer = (state, action) => {
  switch (action.type) {
    case 'FETCH_START':
      return { ...state, loading: true, error: null };
    
    case 'FETCH_SUCCESS':
      return { ...state, loading: false, sessions: action.payload };
    
    case 'START_EDIT':
      return { 
        ...state, 
        editingId: action.payload.id,
        editingName: action.payload.name 
      };
    
    case 'SAVE_EDIT':
      return {
        ...state,
        sessions: state.sessions.map(s => 
          s.id === state.editingId 
            ? { ...s, name: state.editingName }
            : s
        ),
        editingId: null,
        editingName: ''
      };
    
    default:
      return state;
  }
};
```

---

## ğŸ’¡ ç»„ä»¶è®¾è®¡åŸåˆ™

### å•ä¸€èŒè´£åŸåˆ™
- **SessionSidebar**ï¼šæ•´ä½“å¸ƒå±€å’ŒçŠ¶æ€åè°ƒ
- **SessionList**ï¼šä¼šè¯åˆ—è¡¨æ¸²æŸ“å’Œæ»šåŠ¨ç®¡ç†
- **SessionItem**ï¼šå•ä¸ªä¼šè¯çš„å±•ç¤ºå’Œäº¤äº’
- **SessionActions**ï¼šä¼šè¯æ“ä½œèœå•

### å¯å¤ç”¨æ€§è®¾è®¡
- **çµæ´»çš„Propsæ¥å£**ï¼šæ”¯æŒä¸åŒä½¿ç”¨åœºæ™¯
- **æ’æ§½æ¨¡å¼**ï¼šå…è®¸è‡ªå®šä¹‰å¤´éƒ¨å’Œåº•éƒ¨å†…å®¹
- **ä¸»é¢˜ç³»ç»Ÿ**ï¼šæ”¯æŒæ·±è‰²/æµ…è‰²ä¸»é¢˜åˆ‡æ¢
- **å°ºå¯¸å˜ä½“**ï¼šæ”¯æŒä¸åŒå°ºå¯¸çš„ä¾§è¾¹æ 

### æ€§èƒ½ä¼˜åŒ–è€ƒè™‘
- **React.memo**ï¼šé¿å…ä¸å¿…è¦çš„é‡æ¸²æŸ“
- **useMemo/useCallback**ï¼šç¼“å­˜è®¡ç®—ç»“æœå’Œå‡½æ•°
- **è™šæ‹Ÿæ»šåŠ¨**ï¼šå¤„ç†å¤§é‡ä¼šè¯æ•°æ®
- **æ‡’åŠ è½½**ï¼šæŒ‰éœ€åŠ è½½ä¼šè¯è¯¦æƒ…

---

## ğŸ“‹ å­¦ä¹ æ£€æŸ¥ç‚¹

### ç»„ä»¶å®ç°å®Œæˆåº¦
- âœ… **åŸºç¡€ç»„ä»¶ç»“æ„**ï¼šå®Œæ•´çš„ç»„ä»¶å±‚æ¬¡å’ŒPropsè®¾è®¡
- âœ… **ä¼šè¯æ“ä½œåŠŸèƒ½**ï¼šåˆ›å»ºã€é‡å‘½åã€åˆ é™¤ã€åˆ‡æ¢
- âœ… **æœç´¢å’Œè¿‡æ»¤**ï¼šå®æ—¶æœç´¢å’Œç»“æœè¿‡æ»¤
- âœ… **å“åº”å¼è®¾è®¡**ï¼šç§»åŠ¨ç«¯å’Œæ¡Œé¢ç«¯é€‚é…
- âœ… **æ€§èƒ½ä¼˜åŒ–**ï¼šè™šæ‹Ÿæ»šåŠ¨å’Œæ¸²æŸ“ä¼˜åŒ–

### æŠ€èƒ½æŒæ¡è¯„ä¼°
- **Reactç»„ä»¶è®¾è®¡**ï¼šé«˜çº§ç»„ä»¶æ¶æ„å’Œæ¨¡å¼
- **çŠ¶æ€ç®¡ç†**ï¼šå¤æ‚äº¤äº’çŠ¶æ€çš„ä¼˜é›…å¤„ç†
- **ç”¨æˆ·ä½“éªŒ**ï¼šæµç•…çš„åŠ¨ç”»å’Œäº¤äº’åé¦ˆ
- **æ€§èƒ½ä¼˜åŒ–**ï¼šå¤§æ•°æ®é‡æ¸²æŸ“å’Œå†…å­˜ç®¡ç†

**æ­å–œå®Œæˆ8.2èŠ‚å­¦ä¹ ï¼æ‚¨å·²æŒæ¡ä¼ä¸šçº§Reactç»„ä»¶çš„è®¾è®¡å’Œå®ç°æŠ€å·§ï¼** ğŸ‰
