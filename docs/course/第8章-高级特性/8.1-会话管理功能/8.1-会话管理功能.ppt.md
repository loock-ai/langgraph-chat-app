---
marp: true
theme: gaia
paginate: true
header: '8.1-会话管理功能'
style: |
  section {
    font-size: 30px;
  }
---

<!-- _class: lead -->
# 8.1 会话管理功能 💼

## 构建完整的多会话管理系统

**第8章：高级特性**

---

## 🎯 学习目标

完成本节学习后，您将能够：

- **设计高效的会话数据模型**：掌握会话表结构设计和数据库优化
- **实现完整的会话CRUD操作**：构建会话创建、读取、更新、删除的API接口
- **建立会话持久化机制**：确保会话数据的可靠存储和快速检索
- **掌握会话状态管理**：处理会话切换、数据同步和状态一致性
- **优化会话数据库性能**：通过索引和查询优化提升系统响应速度

---

## 💾 会话数据模型设计

### 核心数据结构
```typescript
interface Session {
  id: string;              // 会话唯一标识符
  name: string;            // 会话显示名称
  createdAt: string;       // 创建时间
  updatedAt: string;       // 最后更新时间
  messageCount: number;    // 消息数量统计
  status: 'active' | 'archived' | 'deleted';
}
```

### 设计原则
- **唯一性保证**：使用UUID确保会话ID全局唯一
- **时间戳管理**：自动维护创建和更新时间
- **软删除策略**：标记删除而非物理删除
- **统计信息**：实时维护消息数量等统计数据

---

## 🏗️ 数据库表设计

### SQLite表结构
```sql
CREATE TABLE IF NOT EXISTS sessions (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  message_count INTEGER DEFAULT 0,
  status TEXT DEFAULT 'active'
);
```

### 索引优化策略
```sql
-- 按更新时间降序查询优化
CREATE INDEX idx_sessions_updated_at ON sessions(updated_at DESC);

-- 按状态和时间组合查询优化  
CREATE INDEX idx_sessions_status_updated ON sessions(status, updated_at DESC);

-- 支持会话名称搜索
CREATE INDEX idx_sessions_name_search ON sessions(name COLLATE NOCASE);
```

---

## 🔧 核心CRUD操作实现

### 创建会话
```typescript
export function createSession(id: string, name: string): Session {
  const stmt = db.prepare(`
    INSERT INTO sessions (id, name, created_at, updated_at) 
    VALUES (?, ?, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
  `);
  
  stmt.run(id, name);
  
  return {
    id, name,
    createdAt: new Date().toISOString(),
    messageCount: 0,
    status: 'active'
  };
}
```

### 获取会话列表
```typescript
export function getAllSessions(): Session[] {
  const stmt = db.prepare(`
    SELECT s.*, COUNT(m.id) as message_count
    FROM sessions s
    LEFT JOIN messages m ON s.id = m.session_id
    WHERE s.status != 'deleted'
    GROUP BY s.id
    ORDER BY s.updated_at DESC
  `);
  
  return stmt.all().map(formatSession);
}
```

---

## 🌐 RESTful API接口设计

### API路由规范
```typescript
// GET /api/chat/sessions - 获取会话列表
export async function GET(request: NextRequest) {
  const sessions = getAllSessions();
  return NextResponse.json({ 
    sessions,
    total: sessions.length,
    timestamp: new Date().toISOString()
  });
}

// POST /api/chat/sessions - 创建新会话
export async function POST(request: NextRequest) {
  const { name } = await request.json();
  const sessionId = randomUUID();
  const sessionName = name?.trim() || `新会话-${sessionId.slice(0, 8)}`;
  
  const newSession = createSession(sessionId, sessionName);
  return NextResponse.json(newSession, { status: 201 });
}
```

---

## 🔄 会话操作API

### 更新会话信息
```typescript
// PATCH /api/chat/sessions - 重命名会话
export async function PATCH(request: NextRequest) {
  const { id, name, action } = await request.json();
  
  if (action === 'rename' && name) {
    const success = updateSessionName(id, name.trim());
    
    if (!success) {
      return NextResponse.json(
        { error: '会话重命名失败' }, 
        { status: 404 }
      );
    }
    
    return NextResponse.json({
      success: true,
      message: '会话重命名成功'
    });
  }
}
```

### 删除会话
```typescript
// DELETE /api/chat/sessions - 删除会话
export async function DELETE(request: NextRequest) {
  const { id } = await request.json();
  const success = deleteSession(id); // 软删除
  
  return NextResponse.json({
    success,
    message: success ? '会话已删除' : '会话删除失败'
  });
}
```

---

## ⚡ 性能优化策略

### 数据库连接优化
```typescript
// WAL模式提升并发性能
db.pragma('journal_mode = WAL');
db.pragma('synchronous = NORMAL');
db.pragma('cache_size = 1000000');

// 预编译语句重用
const getSessionsStmt = db.prepare(`
  SELECT * FROM sessions 
  WHERE status = 'active' 
  ORDER BY updated_at DESC 
  LIMIT ?
`);
```

### 分页查询实现
```typescript
export function getSessionsPaginated(page = 1, limit = 20) {
  const offset = (page - 1) * limit;
  
  const sessions = db.prepare(`
    SELECT s.*, COUNT(m.id) as message_count
    FROM sessions s
    LEFT JOIN messages m ON s.id = m.session_id
    WHERE s.status = 'active'
    GROUP BY s.id
    ORDER BY s.updated_at DESC
    LIMIT ? OFFSET ?
  `).all(limit, offset);
  
  return { sessions: sessions.map(formatSession) };
}
```

---

## 🔍 高级查询功能

### 会话搜索实现
```typescript
export function searchSessions(keyword: string, limit = 10) {
  const stmt = db.prepare(`
    SELECT s.*, COUNT(m.id) as message_count
    FROM sessions s
    LEFT JOIN messages m ON s.id = m.session_id
    WHERE s.status = 'active' 
      AND (s.name LIKE ? OR EXISTS (
        SELECT 1 FROM messages 
        WHERE session_id = s.id AND content LIKE ?
      ))
    GROUP BY s.id
    ORDER BY s.updated_at DESC
    LIMIT ?
  `);
  
  const searchTerm = `%${keyword}%`;
  return stmt.all(searchTerm, searchTerm, limit);
}
```

### 会话统计信息
```typescript
export function getSessionStats() {
  return db.prepare(`
    SELECT 
      COUNT(*) as total_sessions,
      COUNT(CASE WHEN status = 'active' THEN 1 END) as active_sessions,
      SUM((SELECT COUNT(*) FROM messages 
           WHERE messages.session_id = sessions.id)) as total_messages
    FROM sessions
    WHERE status != 'deleted'
  `).get();
}
```

---

## 🛡️ 数据安全和完整性

### 事务处理
```typescript
export function createSessionWithMessage(sessionData, messageData) {
  const transaction = db.transaction(() => {
    // 创建会话
    const session = createSession(sessionData.id, sessionData.name);
    
    // 创建初始消息
    const message = createMessage({
      ...messageData,
      sessionId: sessionData.id
    });
    
    return { session, message };
  });
  
  return transaction();
}
```

### 数据验证
```typescript
function validateSessionData(data) {
  const errors = [];
  
  if (!data.name || data.name.trim().length === 0) {
    errors.push('会话名称不能为空');
  }
  
  if (data.name && data.name.length > 100) {
    errors.push('会话名称不能超过100个字符');
  }
  
  return errors;
}
```

---

## 🧪 测试和验证

### API测试示例
```typescript
// 测试会话创建流程
async function testSessionCreation() {
  const response = await fetch('/api/chat/sessions', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name: '测试会话' })
  });
  
  const newSession = await response.json();
  console.log('创建会话结果:', newSession);
  
  // 验证会话是否在列表中
  const listResponse = await fetch('/api/chat/sessions');
  const { sessions } = await listResponse.json();
  
  const found = sessions.find(s => s.id === newSession.id);
  console.log('会话列表验证:', found ? '✅ 成功' : '❌ 失败');
}
```

---

## 📊 性能监控

### 查询性能分析
```typescript
function measureQueryPerformance() {
  const start = performance.now();
  
  const sessions = getAllSessions();
  
  const end = performance.now();
  const duration = end - start;
  
  console.log(`查询${sessions.length}个会话耗时: ${duration.toFixed(2)}ms`);
  
  if (duration > 100) {
    console.warn('⚠️ 查询时间过长，考虑优化索引');
  }
}
```

### 内存缓存优化
```typescript
class SessionCache {
  private cache = new Map<string, Session>();
  private maxSize = 100;
  
  get(id: string): Session | null {
    const session = this.cache.get(id);
    if (session) {
      // LRU策略：移到末尾
      this.cache.delete(id);
      this.cache.set(id, session);
    }
    return session || null;
  }
  
  set(id: string, session: Session): void {
    if (this.cache.size >= this.maxSize) {
      const firstKey = this.cache.keys().next().value;
      this.cache.delete(firstKey);
    }
    this.cache.set(id, session);
  }
}
```

---

## 💡 最佳实践总结

### 数据设计原则
- **软删除策略**：标记删除便于数据恢复
- **时间戳自动维护**：创建和更新时间自动管理
- **统计信息实时更新**：消息数量等统计数据实时维护
- **索引合理设计**：根据查询模式优化索引

### API设计规范
- **RESTful风格**：遵循标准HTTP方法语义
- **统一响应格式**：成功和错误响应格式一致
- **参数验证**：输入数据严格验证和清理
- **错误处理**：提供详细的错误信息和状态码

### 性能优化要点
- **预编译语句**：重复查询使用预编译语句
- **连接池管理**：合理配置数据库连接参数
- **分页查询**：大数据量查询实现分页
- **缓存策略**：热点数据使用内存缓存

---

## 🚀 扩展功能展望

### 高级功能
- **会话标签系统**：为会话添加分类标签
- **会话模板**：预定义会话模板快速创建
- **会话导入导出**：支持数据备份和迁移
- **会话共享**：多用户会话协作功能

### 技术演进
- **分布式存储**：大规模数据分库分表
- **读写分离**：查询和写入性能优化
- **实时同步**：多端会话状态实时同步
- **智能推荐**：基于历史的会话推荐

---

## 📋 学习检查点

### 核心技能掌握
- ✅ **数据模型设计**：会话表结构和字段定义
- ✅ **SQL查询优化**：索引设计和查询性能调优
- ✅ **API接口开发**：RESTful接口的完整实现
- ✅ **数据操作**：CRUD操作的安全可靠实现
- ✅ **性能监控**：查询性能分析和优化策略

### 实践任务完成
- 🎯 创建完整的会话管理数据库
- 🎯 实现所有会话操作API接口
- 🎯 添加查询优化和性能监控
- 🎯 完成API功能测试和验证

**恭喜完成8.1节学习！您已掌握企业级会话管理系统的核心技术！** 🎉
