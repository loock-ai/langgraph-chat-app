---
marp: true
theme: gaia
paginate: true
header: '3.2-Next.js项目应用'
style: |
  section {
    font-size: 30px;
  }
---

<!-- _class: lead -->
# 3.2 Next.js项目应用 🚀

## 构建现代化全栈React应用

**LangGraph智能聊天应用开发教程**

---

## 🎯 学习目标概述

### 本节课的核心价值
- **🚀 掌握Next.js核心特性**：App Router、API Routes、优化功能
- **🌐 构建全栈应用**：前端界面与后端API的无缝集成
- **⚡ 性能优化实践**：利用Next.js的内置优化功能
- **🛠️ 开发体验提升**：热重载、类型检查、调试工具

### 具体学习目标
- 理解Next.js App Router的工作原理
- 创建AI聊天应用的API路由
- 实现服务端渲染和客户端渲染
- 掌握Next.js的部署和优化策略

---

## 🚀 Next.js架构概览

### Next.js的核心优势
```
🔄 全栈能力      ➜  前端 + API路由一体化
⚡ 性能优化      ➜  自动代码分割和优化  
🎯 开发体验      ➜  热重载和强大工具链
📱 生产就绪      ➜  内置SEO和部署优化
```

### App Router vs Pages Router
- **📁 App Router**：新一代路由系统（Next.js 13+）
- **📄 Pages Router**：传统路由系统（仍然支持）
- **🎯 选择建议**：新项目优先使用App Router

---

## 📁 App Router文件系统

### 路由文件结构
```
app/
├── page.tsx              # 根页面 (/)
├── layout.tsx            # 根布局
├── loading.tsx           # 加载状态
├── error.tsx             # 错误边界
├── not-found.tsx         # 404页面
├── globals.css           # 全局样式
├── api/                  # API路由
│   ├── chat/
│   │   └── route.ts      # /api/chat
│   └── sessions/
│       ├── route.ts      # /api/sessions
│       └── [id]/
│           └── route.ts  # /api/sessions/[id]
└── components/           # 共享组件
    ├── ChatMessage.tsx
    └── SessionSidebar.tsx
```

### 特殊文件说明
- **page.tsx**：页面组件
- **layout.tsx**：布局组件
- **loading.tsx**：加载UI
- **error.tsx**：错误处理
- **route.ts**：API路由处理

---

## 🏠 页面组件实现

### 根布局组件
```tsx
// app/layout.tsx
import type { Metadata } from 'next';
import { Inter } from 'next/font/google';
import './globals.css';

const inter = Inter({ subsets: ['latin'] });

export const metadata: Metadata = {
  title: 'LangGraph Chat App',
  description: 'AI聊天应用开发教程',
  keywords: ['AI', 'Chat', 'LangGraph', 'Next.js'],
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="zh-CN">
      <head>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
      </head>
      <body className={`${inter.className} antialiased`}>
        <main className="min-h-screen bg-gray-50">
          {children}
        </main>
      </body>
    </html>
  );
}
```

### 主页面组件
```tsx
// app/page.tsx
'use client';

import { useState } from 'react';
import { ChatContainer } from '@/components/ChatContainer';
import { SessionSidebar } from '@/components/SessionSidebar';

export default function HomePage() {
  const [currentSessionId, setCurrentSessionId] = useState<string | null>(null);
  const [sidebarOpen, setSidebarOpen] = useState(true);

  return (
    <div className="flex h-screen bg-white">
      {/* 移动端侧边栏覆盖 */}
      {sidebarOpen && (
        <div 
          className="fixed inset-0 z-40 lg:hidden bg-black bg-opacity-50"
          onClick={() => setSidebarOpen(false)}
        />
      )}
      
      {/* 侧边栏 */}
      <div className={`
        ${sidebarOpen ? 'translate-x-0' : '-translate-x-full'}
        fixed lg:relative lg:translate-x-0 
        z-50 lg:z-auto
        transition-transform duration-300 ease-in-out
        lg:transition-none
      `}>
        <SessionSidebar
          currentSessionId={currentSessionId}
          onSessionSelect={setCurrentSessionId}
          onClose={() => setSidebarOpen(false)}
        />
      </div>

      {/* 主聊天区域 */}
      <div className="flex-1 flex flex-col">
        {/* 头部栏 */}
        <header className="bg-white border-b border-gray-200 px-4 py-3 flex items-center">
          <button
            onClick={() => setSidebarOpen(!sidebarOpen)}
            className="lg:hidden mr-3 p-1 rounded-md text-gray-500 hover:text-gray-700"
          >
            <MenuIcon className="w-6 h-6" />
          </button>
          <h1 className="text-lg font-semibold text-gray-800">
            LangGraph Chat App
          </h1>
        </header>

        {/* 聊天容器 */}
        <div className="flex-1">
          <ChatContainer 
            sessionId={currentSessionId}
            onSessionChange={setCurrentSessionId}
          />
        </div>
      </div>
    </div>
  );
}
```

---

## 🔗 API Routes实现

### 聊天API路由
```tsx
// app/api/chat/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { ChatOpenAI } from '@langchain/openai';
import { loadEnvConfig } from '@/utils/loadEnv';

// 支持POST请求
export async function POST(request: NextRequest) {
  try {
    const { message, sessionId } = await request.json();

    // 验证输入
    if (!message || typeof message !== 'string') {
      return NextResponse.json(
        { error: '消息内容不能为空' },
        { status: 400 }
      );
    }

    // 加载配置
    const config = loadEnvConfig();
    
    // 初始化AI模型
    const model = new ChatOpenAI({
      openAIApiKey: config.openai.apiKey,
      modelName: config.openai.model,
      temperature: config.openai.temperature,
      maxTokens: config.openai.maxTokens,
    });

    // 获取会话历史
    const sessionHistory = sessionId 
      ? await getSessionHistory(sessionId)
      : [];

    // 构建消息历史
    const messages = [
      ...sessionHistory,
      { role: 'user', content: message }
    ];

    // 调用AI模型
    const response = await model.invoke(messages);

    // 保存消息到数据库
    await saveMessage({
      sessionId: sessionId || await createNewSession(),
      userMessage: message,
      aiResponse: response.content,
    });

    return NextResponse.json({
      id: Date.now().toString(),
      content: response.content,
      role: 'assistant',
      timestamp: new Date().toISOString(),
    });

  } catch (error) {
    console.error('聊天API错误:', error);
    return NextResponse.json(
      { error: '处理消息时发生错误' },
      { status: 500 }
    );
  }
}

// 如果需要支持GET请求
export async function GET() {
  return NextResponse.json({ 
    message: '聊天API运行正常',
    timestamp: new Date().toISOString()
  });
}
```

### 流式响应API
```tsx
// app/api/chat/stream/route.ts
import { NextRequest } from 'next/server';
import { ChatOpenAI } from '@langchain/openai';

export async function POST(request: NextRequest) {
  const { message, sessionId } = await request.json();

  // 创建流式响应
  const encoder = new TextEncoder();
  const stream = new ReadableStream({
    async start(controller) {
      try {
        const model = new ChatOpenAI({
          streaming: true,
          openAIApiKey: process.env.OPENAI_API_KEY,
        });

        let fullResponse = '';

        await model.invoke([{ role: 'user', content: message }], {
          callbacks: [{
            handleLLMNewToken(token: string) {
              fullResponse += token;
              
              // 发送令牌到客户端
              const data = JSON.stringify({
                type: 'token',
                content: token,
                fullContent: fullResponse
              });
              
              controller.enqueue(encoder.encode(`data: ${data}\n\n`));
            },
            handleLLMEnd() {
              // 发送结束信号
              const data = JSON.stringify({
                type: 'end',
                content: fullResponse
              });
              
              controller.enqueue(encoder.encode(`data: ${data}\n\n`));
              controller.close();
            }
          }]
        });

      } catch (error) {
        controller.error(error);
      }
    },
  });

  return new Response(stream, {
    headers: {
      'Content-Type': 'text/event-stream',
      'Cache-Control': 'no-cache',
      'Connection': 'keep-alive',
    },
  });
}
```

---

## 📊 会话管理API

### 会话CRUD操作
```tsx
// app/api/sessions/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { getSessionsFromDB, createSessionInDB } from '@/utils/database';

// 获取所有会话
export async function GET() {
  try {
    const sessions = await getSessionsFromDB();
    return NextResponse.json(sessions);
  } catch (error) {
    return NextResponse.json(
      { error: '获取会话列表失败' },
      { status: 500 }
    );
  }
}

// 创建新会话
export async function POST(request: NextRequest) {
  try {
    const { title } = await request.json();
    
    const session = await createSessionInDB({
      title: title || '新对话',
      createdAt: new Date(),
    });

    return NextResponse.json(session, { status: 201 });
  } catch (error) {
    return NextResponse.json(
      { error: '创建会话失败' },
      { status: 500 }
    );
  }
}
```

### 单个会话操作
```tsx
// app/api/sessions/[id]/route.ts
import { NextRequest, NextResponse } from 'next/server';

interface RouteParams {
  params: { id: string };
}

// 获取特定会话
export async function GET(
  request: NextRequest,
  { params }: RouteParams
) {
  try {
    const sessionId = params.id;
    const session = await getSessionById(sessionId);
    
    if (!session) {
      return NextResponse.json(
        { error: '会话不存在' },
        { status: 404 }
      );
    }

    return NextResponse.json(session);
  } catch (error) {
    return NextResponse.json(
      { error: '获取会话失败' },
      { status: 500 }
    );
  }
}

// 删除会话
export async function DELETE(
  request: NextRequest,
  { params }: RouteParams
) {
  try {
    const sessionId = params.id;
    await deleteSessionFromDB(sessionId);
    
    return NextResponse.json({ 
      message: '会话删除成功' 
    });
  } catch (error) {
    return NextResponse.json(
      { error: '删除会话失败' },
      { status: 500 }
    );
  }
}

// 更新会话
export async function PATCH(
  request: NextRequest,
  { params }: RouteParams
) {
  try {
    const sessionId = params.id;
    const updates = await request.json();
    
    const updatedSession = await updateSessionInDB(sessionId, updates);
    
    return NextResponse.json(updatedSession);
  } catch (error) {
    return NextResponse.json(
      { error: '更新会话失败' },
      { status: 500 }
    );
  }
}
```

---

## 🔄 数据获取策略

### 客户端数据获取
```tsx
// hooks/useSession.ts
import { useState, useEffect } from 'react';

export function useSession(sessionId: string | null) {
  const [session, setSession] = useState(null);
  const [messages, setMessages] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  useEffect(() => {
    if (!sessionId) {
      setSession(null);
      setMessages([]);
      return;
    }

    const fetchSession = async () => {
      setLoading(true);
      setError(null);
      
      try {
        // 并行获取会话信息和消息
        const [sessionRes, messagesRes] = await Promise.all([
          fetch(`/api/sessions/${sessionId}`),
          fetch(`/api/sessions/${sessionId}/messages`)
        ]);

        if (!sessionRes.ok || !messagesRes.ok) {
          throw new Error('获取会话数据失败');
        }

        const sessionData = await sessionRes.json();
        const messagesData = await messagesRes.json();

        setSession(sessionData);
        setMessages(messagesData);
      } catch (err) {
        setError(err.message);
      } finally {
        setLoading(false);
      }
    };

    fetchSession();
  }, [sessionId]);

  return { session, messages, loading, error, setMessages };
}
```

### 服务端数据获取
```tsx
// app/sessions/[id]/page.tsx
import { notFound } from 'next/navigation';
import { getSessionById, getSessionMessages } from '@/utils/database';
import { ChatContainer } from '@/components/ChatContainer';

interface PageProps {
  params: { id: string };
}

export default async function SessionPage({ params }: PageProps) {
  const sessionId = params.id;
  
  // 服务端获取数据
  const [session, messages] = await Promise.all([
    getSessionById(sessionId),
    getSessionMessages(sessionId)
  ]);

  // 如果会话不存在，显示404
  if (!session) {
    notFound();
  }

  return (
    <div className="h-screen">
      <ChatContainer 
        initialSession={session}
        initialMessages={messages}
      />
    </div>
  );
}

// 生成静态元数据
export async function generateMetadata({ params }: PageProps) {
  const session = await getSessionById(params.id);
  
  return {
    title: session ? `${session.title} - Chat App` : 'Session Not Found',
  };
}
```

---

## ⚡ 性能优化技术

### 代码分割和懒加载
```tsx
// 组件懒加载
import { lazy, Suspense } from 'react';

const SessionSidebar = lazy(() => import('@/components/SessionSidebar'));
const ChatSettings = lazy(() => import('@/components/ChatSettings'));

export default function HomePage() {
  return (
    <div className="flex h-screen">
      <Suspense fallback={<SidebarSkeleton />}>
        <SessionSidebar />
      </Suspense>
      
      <div className="flex-1">
        <ChatContainer />
        
        <Suspense fallback={<div>加载设置...</div>}>
          <ChatSettings />
        </Suspense>
      </div>
    </div>
  );
}
```

### 图片优化
```tsx
// 使用Next.js Image组件
import Image from 'next/image';

export function UserAvatar({ user }) {
  return (
    <Image
      src={user.avatar || '/default-avatar.png'}
      alt={`${user.name}的头像`}
      width={40}
      height={40}
      className="rounded-full"
      priority={false} // 非关键图片
      placeholder="blur"
      blurDataURL="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQ..." // 模糊占位符
    />
  );
}
```

### 缓存策略
```tsx
// app/api/sessions/route.ts
import { NextResponse } from 'next/server';

export async function GET() {
  const sessions = await getSessionsFromDB();
  
  const response = NextResponse.json(sessions);
  
  // 设置缓存头
  response.headers.set(
    'Cache-Control',
    'public, s-maxage=60, stale-while-revalidate=300'
  );
  
  return response;
}
```

---

## 🛠️ 错误处理和加载状态

### 错误边界
```tsx
// app/error.tsx
'use client';

import { useEffect } from 'react';

export default function Error({
  error,
  reset,
}: {
  error: Error & { digest?: string };
  reset: () => void;
}) {
  useEffect(() => {
    // 错误日志记录
    console.error('应用错误:', error);
  }, [error]);

  return (
    <div className="flex flex-col items-center justify-center min-h-screen">
      <div className="text-center">
        <h2 className="text-2xl font-bold text-gray-900 mb-4">
          出现了一些问题
        </h2>
        <p className="text-gray-600 mb-6">
          抱歉，应用遇到了错误。请尝试刷新页面。
        </p>
        <button
          onClick={reset}
          className="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600"
        >
          重试
        </button>
      </div>
    </div>
  );
}
```

### 加载状态
```tsx
// app/loading.tsx
export default function Loading() {
  return (
    <div className="flex items-center justify-center min-h-screen">
      <div className="flex flex-col items-center">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
        <p className="mt-4 text-gray-600">加载中...</p>
      </div>
    </div>
  );
}

// 组件级加载状态
function ChatContainer() {
  const [isLoading, setIsLoading] = useState(true);
  
  if (isLoading) {
    return <ChatSkeleton />;
  }
  
  return (
    <div className="chat-container">
      {/* 聊天内容 */}
    </div>
  );
}

function ChatSkeleton() {
  return (
    <div className="animate-pulse p-4">
      <div className="space-y-4">
        {[...Array(5)].map((_, i) => (
          <div key={i} className="flex space-x-4">
            <div className="rounded-full bg-gray-200 h-10 w-10"></div>
            <div className="flex-1 space-y-2">
              <div className="h-4 bg-gray-200 rounded w-3/4"></div>
              <div className="h-4 bg-gray-200 rounded w-1/2"></div>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}
```

---

## 🌐 环境配置和部署

### 环境变量配置
```typescript
// next.config.ts
import type { NextConfig } from 'next';

const nextConfig: NextConfig = {
  // 环境变量
  env: {
    CUSTOM_KEY: process.env.CUSTOM_KEY,
  },
  
  // 实验性功能
  experimental: {
    serverComponentsExternalPackages: ['@langchain/langgraph'],
  },
  
  // 图片域名配置
  images: {
    domains: ['example.com', 'cdn.example.com'],
    formats: ['image/webp', 'image/avif'],
  },
  
  // 重写规则
  async rewrites() {
    return [
      {
        source: '/api/v1/:path*',
        destination: '/api/:path*',
      },
    ];
  },
  
  // 重定向规则
  async redirects() {
    return [
      {
        source: '/chat',
        destination: '/',
        permanent: true,
      },
    ];
  },
};

export default nextConfig;
```

### 部署配置
```json
// vercel.json
{
  "functions": {
    "app/api/**/*.ts": {
      "maxDuration": 30
    }
  },
  "env": {
    "OPENAI_API_KEY": "@openai_api_key",
    "DATABASE_URL": "@database_url"
  },
  "build": {
    "env": {
      "NEXT_PUBLIC_APP_URL": "https://your-app.vercel.app"
    }
  }
}
```

---

## 🔧 开发工具和调试

### Next.js DevTools
```tsx
// 开发环境调试信息
if (process.env.NODE_ENV === 'development') {
  console.log('开发模式调试信息:', {
    sessionId: currentSessionId,
    messagesCount: messages.length,
    isLoading,
  });
}

// 性能监控
export function reportWebVitals(metric) {
  if (process.env.NODE_ENV === 'production') {
    // 发送到分析服务
    analytics.track('Web Vital', {
      name: metric.name,
      value: metric.value,
    });
  }
}
```

### TypeScript配置优化
```json
// tsconfig.json
{
  "compilerOptions": {
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./app/*"],
      "@/components/*": ["./app/components/*"],
      "@/utils/*": ["./app/utils/*"],
      "@/hooks/*": ["./app/hooks/*"],
      "@/types/*": ["./app/types/*"]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts"
  ]
}
```

---

<!-- _class: lead -->
# 🎉 Next.js项目应用完成！

## 现在拥有了强大的全栈应用能力

**下一节：TypeScript实际应用**
