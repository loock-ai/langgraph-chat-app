---
marp: true
theme: gaia
paginate: true
header: '4.2-æ•°æ®åº“å®é™…åº”ç”¨'
style: |
  section {
    font-size: 30px;
  }
---

<!-- _class: lead -->
# ç¬¬4ç«  åç«¯åŸºç¡€ ğŸ”™

## 4.2 æ•°æ®åº“å®é™…åº”ç”¨

**SQLiteè½»é‡çº§æ•°æ®å­˜å‚¨è§£å†³æ–¹æ¡ˆ**

---

## ğŸ¯ å­¦ä¹ ç›®æ ‡

- **æŒæ¡SQLiteæ•°æ®åº“åŸºç¡€æ“ä½œ**
- **å­¦ä¼šè®¾è®¡ç®€å•çš„æ•°æ®æ¨¡å‹**
- **å®ç°åŸºæœ¬çš„CRUDåŠŸèƒ½**
- **ç†è§£æ•°æ®åº“è¿æ¥ç®¡ç†**

ä¸ºèŠå¤©åº”ç”¨æ„å»ºå¯é çš„æ•°æ®å­˜å‚¨ï¼

---

## ğŸ“š SQLiteåŸºç¡€åº”ç”¨

### è½»é‡çº§æ•°æ®åº“ä¼˜åŠ¿
- **é›¶é…ç½®** - æ— éœ€å®‰è£…å’Œé…ç½®æ•°æ®åº“æœåŠ¡å™¨
- **é«˜æ€§èƒ½** - ç›´æ¥æ–‡ä»¶è®¿é—®ï¼Œé€Ÿåº¦å¿«
- **å¯ç§»æ¤** - å•æ–‡ä»¶æ•°æ®åº“ï¼Œä¾¿äºéƒ¨ç½²
- **äº‹åŠ¡æ”¯æŒ** - å®Œæ•´çš„ACIDäº‹åŠ¡ç‰¹æ€§

### better-sqlite3åº“ä½¿ç”¨
```typescript
import Database from 'better-sqlite3';

// åˆ›å»ºæ•°æ®åº“è¿æ¥
const db = new Database('chat.db');
console.log('æ•°æ®åº“è¿æ¥æˆåŠŸ');
```

SQLiteæ˜¯å°å‹åº”ç”¨çš„å®Œç¾é€‰æ‹©ï¼

---

## ğŸ—ï¸ æ•°æ®æ¨¡å‹è®¾è®¡

### æ¶ˆæ¯è¡¨ï¼ˆmessagesï¼‰è®¾è®¡
```sql
CREATE TABLE IF NOT EXISTS messages (
  id TEXT PRIMARY KEY,
  content TEXT NOT NULL,
  role TEXT NOT NULL,
  timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
  session_id TEXT NOT NULL
);
```

### ä¼šè¯è¡¨ï¼ˆsessionsï¼‰è®¾è®¡
```sql
CREATE TABLE IF NOT EXISTS sessions (
  id TEXT PRIMARY KEY,
  name TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

ç®€æ´æ¸…æ™°çš„è¡¨ç»“æ„æ˜¯æ•°æ®å­˜å‚¨çš„åŸºç¡€ï¼

---

## ğŸ’¡ æ•°æ®åº“åˆå§‹åŒ–

```typescript
// app/agent/db.ts
import Database from 'better-sqlite3';

const db = new Database('chat.db');

// åˆå§‹åŒ–è¡¨ç»“æ„
export function initDatabase() {
  // åˆ›å»ºæ¶ˆæ¯è¡¨
  db.prepare(`
    CREATE TABLE IF NOT EXISTS messages (
      id TEXT PRIMARY KEY,
      content TEXT,
      role TEXT,
      timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
      session_id TEXT
    )
  `).run();

  // åˆ›å»ºä¼šè¯è¡¨
  db.prepare(`
    CREATE TABLE IF NOT EXISTS sessions (
      id TEXT PRIMARY KEY,
      name TEXT,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP
    )
  `).run();
  
  console.log('æ•°æ®åº“è¡¨åˆå§‹åŒ–å®Œæˆ');
}
```

---

## ğŸ”— åŸºç¡€CRUDæ“ä½œ

### ä¿å­˜æ¶ˆæ¯
```typescript
export function saveMessage(message: Message) {
  const stmt = db.prepare(`
    INSERT INTO messages (id, content, role, session_id) 
    VALUES (?, ?, ?, ?)
  `);
  
  stmt.run(
    message.id, 
    message.content, 
    message.role, 
    message.sessionId
  );
}

// ä½¿ç”¨ç¤ºä¾‹
saveMessage({
  id: '123',
  content: 'ä½ å¥½',
  role: 'user',
  sessionId: 'session-456'
});
```

---

## ğŸ”— æŸ¥è¯¢å†å²è®°å½•

```typescript
// è·å–ä¼šè¯çš„æ‰€æœ‰æ¶ˆæ¯
export function getMessagesBySession(sessionId: string): Message[] {
  const stmt = db.prepare(`
    SELECT * FROM messages 
    WHERE session_id = ? 
    ORDER BY timestamp ASC
  `);
  
  return stmt.all(sessionId);
}

// è·å–æœ€è¿‘çš„æ¶ˆæ¯
export function getRecentMessages(limit: number = 10): Message[] {
  const stmt = db.prepare(`
    SELECT * FROM messages 
    ORDER BY timestamp DESC 
    LIMIT ?
  `);
  
  return stmt.all(limit);
}
```

---

## ğŸŒŸ ä¼šè¯ç®¡ç†æ“ä½œ

### åˆ›å»ºå’Œç®¡ç†ä¼šè¯
```typescript
// åˆ›å»ºæ–°ä¼šè¯
export function createSession(id: string, name: string) {
  const stmt = db.prepare(`
    INSERT INTO sessions (id, name) 
    VALUES (?, ?)
  `);
  stmt.run(id, name);
}

// è·å–æ‰€æœ‰ä¼šè¯
export function getAllSessions(): Session[] {
  const stmt = db.prepare(`
    SELECT id, name, created_at as createdAt 
    FROM sessions 
    ORDER BY created_at DESC
  `);
  return stmt.all();
}

// åˆ é™¤ä¼šè¯
export function deleteSession(id: string) {
  const stmt = db.prepare('DELETE FROM sessions WHERE id = ?');
  stmt.run(id);
}
```

---

## ğŸ”§ äº‹åŠ¡å¤„ç†åŸºç¡€

```typescript
// äº‹åŠ¡ç¤ºä¾‹ï¼šä¿å­˜æ¶ˆæ¯å’Œæ›´æ–°ä¼šè¯
export function saveMessageWithTransaction(message: Message, sessionName?: string) {
  const transaction = db.transaction(() => {
    // ä¿å­˜æ¶ˆæ¯
    saveMessage(message);
    
    // å¦‚æœæä¾›äº†ä¼šè¯åç§°ï¼Œæ›´æ–°ä¼šè¯
    if (sessionName) {
      const updateStmt = db.prepare(`
        UPDATE sessions 
        SET name = ? 
        WHERE id = ?
      `);
      updateStmt.run(sessionName, message.sessionId);
    }
  });
  
  transaction(); // æ‰§è¡Œäº‹åŠ¡
}
```

äº‹åŠ¡ç¡®ä¿æ•°æ®çš„ä¸€è‡´æ€§å’Œå®Œæ•´æ€§ï¼

---

## ğŸ”§ è¿æ¥å’Œæ€§èƒ½ä¼˜åŒ–

### æ•°æ®åº“è¿æ¥ç®¡ç†
```typescript
// å•ä¾‹æ¨¡å¼ç®¡ç†æ•°æ®åº“è¿æ¥
class DatabaseManager {
  private static instance: Database.Database;
  
  static getInstance(): Database.Database {
    if (!this.instance) {
      this.instance = new Database('chat.db');
      this.instance.pragma('journal_mode = WAL'); // ä¼˜åŒ–å†™å…¥æ€§èƒ½
    }
    return this.instance;
  }
  
  static close() {
    if (this.instance) {
      this.instance.close();
    }
  }
}

export const db = DatabaseManager.getInstance();
```

---

## ğŸ“‹ æ€»ç»“è¦ç‚¹

- **SQLiteä¼˜åŠ¿** - è½»é‡çº§ä½†åŠŸèƒ½å¼ºå¤§çš„æ•°æ®åº“
- **æ•°æ®æ¨¡å‹** - åˆç†çš„è¡¨è®¾è®¡æ˜¯å­˜å‚¨çš„åŸºç¡€
- **CRUDæ“ä½œ** - å¢åˆ æ”¹æŸ¥æ»¡è¶³å¤§éƒ¨åˆ†åº”ç”¨éœ€æ±‚
- **äº‹åŠ¡å¤„ç†** - ç¡®ä¿æ•°æ®æ“ä½œçš„åŸå­æ€§
- **æ€§èƒ½ä¼˜åŒ–** - è¿æ¥ç®¡ç†å’Œé…ç½®ä¼˜åŒ–

better-sqlite3æä¾›äº†ç®€æ´çš„Node.jsæ¥å£ï¼

---

## ğŸš€ ä¸‹ä¸€æ­¥é¢„å‘Š

æŒæ¡äº†æ•°æ®åº“åŸºç¡€åï¼Œæˆ‘ä»¬å°†å­¦ä¹ ï¼š

**4.3 æµå¼å“åº”å®ç°**
- ReadableStreamåŸºç¡€API
- æµå¼æ•°æ®ä¼ è¾“åŸç†
- èŠå¤©åº”ç”¨æµå¼å®ç°
- ä¸ºAIé›†æˆåšæŠ€æœ¯å‡†å¤‡

è®©æ•°æ®ä¼ è¾“æ›´åŠ æµç•…ï¼
