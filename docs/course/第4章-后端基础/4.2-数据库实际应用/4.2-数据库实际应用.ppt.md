---
marp: true
theme: gaia
paginate: true
header: '4.2-数据库实际应用'
style: |
  section {
    font-size: 30px;
  }
---

<!-- _class: lead -->
# 第4章 后端基础 🔙

## 4.2 数据库实际应用

**SQLite轻量级数据存储解决方案**

---

## 🎯 学习目标

- **掌握SQLite数据库基础操作**
- **学会设计简单的数据模型**
- **实现基本的CRUD功能**
- **理解数据库连接管理**

为聊天应用构建可靠的数据存储！

---

## 📚 SQLite基础应用

### 轻量级数据库优势
- **零配置** - 无需安装和配置数据库服务器
- **高性能** - 直接文件访问，速度快
- **可移植** - 单文件数据库，便于部署
- **事务支持** - 完整的ACID事务特性

### better-sqlite3库使用
```typescript
import Database from 'better-sqlite3';

// 创建数据库连接
const db = new Database('chat.db');
console.log('数据库连接成功');
```

SQLite是小型应用的完美选择！

---

## 🏗️ 数据模型设计

### 消息表（messages）设计
```sql
CREATE TABLE IF NOT EXISTS messages (
  id TEXT PRIMARY KEY,
  content TEXT NOT NULL,
  role TEXT NOT NULL,
  timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
  session_id TEXT NOT NULL
);
```

### 会话表（sessions）设计
```sql
CREATE TABLE IF NOT EXISTS sessions (
  id TEXT PRIMARY KEY,
  name TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

简洁清晰的表结构是数据存储的基础！

---

## 💡 数据库初始化

```typescript
// app/agent/db.ts
import Database from 'better-sqlite3';

const db = new Database('chat.db');

// 初始化表结构
export function initDatabase() {
  // 创建消息表
  db.prepare(`
    CREATE TABLE IF NOT EXISTS messages (
      id TEXT PRIMARY KEY,
      content TEXT,
      role TEXT,
      timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
      session_id TEXT
    )
  `).run();

  // 创建会话表
  db.prepare(`
    CREATE TABLE IF NOT EXISTS sessions (
      id TEXT PRIMARY KEY,
      name TEXT,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP
    )
  `).run();
  
  console.log('数据库表初始化完成');
}
```

---

## 🔗 基础CRUD操作

### 保存消息
```typescript
export function saveMessage(message: Message) {
  const stmt = db.prepare(`
    INSERT INTO messages (id, content, role, session_id) 
    VALUES (?, ?, ?, ?)
  `);
  
  stmt.run(
    message.id, 
    message.content, 
    message.role, 
    message.sessionId
  );
}

// 使用示例
saveMessage({
  id: '123',
  content: '你好',
  role: 'user',
  sessionId: 'session-456'
});
```

---

## 🔗 查询历史记录

```typescript
// 获取会话的所有消息
export function getMessagesBySession(sessionId: string): Message[] {
  const stmt = db.prepare(`
    SELECT * FROM messages 
    WHERE session_id = ? 
    ORDER BY timestamp ASC
  `);
  
  return stmt.all(sessionId);
}

// 获取最近的消息
export function getRecentMessages(limit: number = 10): Message[] {
  const stmt = db.prepare(`
    SELECT * FROM messages 
    ORDER BY timestamp DESC 
    LIMIT ?
  `);
  
  return stmt.all(limit);
}
```

---

## 🌟 会话管理操作

### 创建和管理会话
```typescript
// 创建新会话
export function createSession(id: string, name: string) {
  const stmt = db.prepare(`
    INSERT INTO sessions (id, name) 
    VALUES (?, ?)
  `);
  stmt.run(id, name);
}

// 获取所有会话
export function getAllSessions(): Session[] {
  const stmt = db.prepare(`
    SELECT id, name, created_at as createdAt 
    FROM sessions 
    ORDER BY created_at DESC
  `);
  return stmt.all();
}

// 删除会话
export function deleteSession(id: string) {
  const stmt = db.prepare('DELETE FROM sessions WHERE id = ?');
  stmt.run(id);
}
```

---

## 🔧 事务处理基础

```typescript
// 事务示例：保存消息和更新会话
export function saveMessageWithTransaction(message: Message, sessionName?: string) {
  const transaction = db.transaction(() => {
    // 保存消息
    saveMessage(message);
    
    // 如果提供了会话名称，更新会话
    if (sessionName) {
      const updateStmt = db.prepare(`
        UPDATE sessions 
        SET name = ? 
        WHERE id = ?
      `);
      updateStmt.run(sessionName, message.sessionId);
    }
  });
  
  transaction(); // 执行事务
}
```

事务确保数据的一致性和完整性！

---

## 🔧 连接和性能优化

### 数据库连接管理
```typescript
// 单例模式管理数据库连接
class DatabaseManager {
  private static instance: Database.Database;
  
  static getInstance(): Database.Database {
    if (!this.instance) {
      this.instance = new Database('chat.db');
      this.instance.pragma('journal_mode = WAL'); // 优化写入性能
    }
    return this.instance;
  }
  
  static close() {
    if (this.instance) {
      this.instance.close();
    }
  }
}

export const db = DatabaseManager.getInstance();
```

---

## 📋 总结要点

- **SQLite优势** - 轻量级但功能强大的数据库
- **数据模型** - 合理的表设计是存储的基础
- **CRUD操作** - 增删改查满足大部分应用需求
- **事务处理** - 确保数据操作的原子性
- **性能优化** - 连接管理和配置优化

better-sqlite3提供了简洁的Node.js接口！

---

## 🚀 下一步预告

掌握了数据库基础后，我们将学习：

**4.3 流式响应实现**
- ReadableStream基础API
- 流式数据传输原理
- 聊天应用流式实现
- 为AI集成做技术准备

让数据传输更加流畅！
