---
marp: true
theme: gaia
paginate: true
header: '2.4-环境变量配置'
style: |
  section {
    font-size: 30px;
  }
---

<!-- _class: lead -->
# 2.4 环境变量配置 ⚙️

## 安全高效的配置管理

**LangGraph智能聊天应用开发教程**

---

## 🎯 学习目标概述

### 本节课的核心价值
- **🔐 掌握安全配置管理**：保护敏感信息如API密钥
- **🌍 理解环境分离**：开发、测试、生产环境的差异化配置
- **⚡ 提升开发效率**：便捷的配置切换和管理

### 具体学习目标
- 理解环境变量的概念和作用
- 掌握.env文件的创建和使用
- 学会配置AI服务API密钥
- 了解不同环境的配置策略

---

## 🔍 环境变量基础概念

### 什么是环境变量？
环境变量是**操作系统级别的配置参数**，用于存储：

- **🔑 API密钥**：OpenAI、Azure等服务密钥
- **🌐 服务端点**：不同环境的API地址
- **📊 配置参数**：数据库连接、缓存设置等
- **🎛️ 功能开关**：特性标志和调试选项

### 为什么使用环境变量？
- **🔒 安全性**：敏感信息不出现在代码中
- **🔄 灵活性**：不修改代码即可改变配置
- **🌍 环境分离**：开发/生产环境使用不同配置
- **👥 团队协作**：每个开发者可有独立配置

---

## 📁 .env文件体系

### 文件优先级顺序
```
.env.local          # 本地配置（最高优先级）
    ↓
.env.development    # 开发环境专用
    ↓  
.env.production     # 生产环境专用
    ↓
.env                # 默认配置（最低优先级）
```

Next.js会按照这个顺序加载环境变量，后加载的会覆盖先加载的。

### 文件用途说明
- **`.env.local`**：个人本地配置，不提交到Git
- **`.env.development`**：开发团队共享的开发配置
- **`.env.production`**：生产环境配置
- **`.env`**：默认配置模板

---

## 🔑 AI服务配置

### OpenAI配置
```bash
# .env.local
# OpenAI配置
OPENAI_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
OPENAI_BASE_URL=https://api.openai.com/v1
OPENAI_MODEL=gpt-4-turbo-preview
OPENAI_MAX_TOKENS=4096
OPENAI_TEMPERATURE=0.7

# 组织ID（可选）
OPENAI_ORGANIZATION=org-xxxxxxxxxxxxxxxxxxxxxxxx
```

### Azure OpenAI配置
```bash
# .env.local
# Azure OpenAI配置
AZURE_OPENAI_API_KEY=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
AZURE_OPENAI_ENDPOINT=https://your-resource.openai.azure.com/
AZURE_OPENAI_API_VERSION=2024-02-15-preview
AZURE_OPENAI_DEPLOYMENT_NAME=gpt-4-turbo

# Azure资源信息
AZURE_OPENAI_RESOURCE_NAME=your-resource-name
```

### 其他AI服务
```bash
# Anthropic Claude
ANTHROPIC_API_KEY=sk-ant-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

# Google Gemini
GOOGLE_API_KEY=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

# 本地LLM服务
LOCAL_LLM_ENDPOINT=http://localhost:11434
LOCAL_LLM_MODEL=llama3:8b
```

---

## 🌍 环境分离配置

### 开发环境配置
```bash
# .env.development
# 开发环境专用配置

# API服务
API_BASE_URL=http://localhost:3000
DEBUG_MODE=true
LOG_LEVEL=debug

# AI服务（开发用）
AI_PROVIDER=openai
AI_MODEL=gpt-3.5-turbo
AI_MAX_TOKENS=2048
AI_TEMPERATURE=0.8

# 数据库（本地）
DATABASE_URL=sqlite:./dev.db
REDIS_URL=redis://localhost:6379

# 功能开关
ENABLE_STREAMING=true
ENABLE_TOOLS=true
ENABLE_ANALYTICS=false
```

### 生产环境配置
```bash
# .env.production
# 生产环境专用配置

# API服务
API_BASE_URL=https://your-app.com
DEBUG_MODE=false
LOG_LEVEL=error

# AI服务（生产用）
AI_PROVIDER=azure-openai
AI_MODEL=gpt-4-turbo
AI_MAX_TOKENS=4096
AI_TEMPERATURE=0.7

# 数据库（云端）
DATABASE_URL=postgresql://username:password@host:port/database
REDIS_URL=redis://redis-host:6379

# 功能开关
ENABLE_STREAMING=true
ENABLE_TOOLS=true
ENABLE_ANALYTICS=true
```

---

## 🔧 Next.js环境变量配置

### 客户端可访问变量
```bash
# 以NEXT_PUBLIC_开头的变量可在客户端访问
NEXT_PUBLIC_APP_NAME=LangGraph Chat App
NEXT_PUBLIC_APP_VERSION=1.0.0
NEXT_PUBLIC_ANALYTICS_ID=G-XXXXXXXXXX
NEXT_PUBLIC_API_BASE_URL=https://api.yourapp.com
```

### 服务端专用变量
```bash
# 不以NEXT_PUBLIC_开头的变量只能在服务端访问
DATABASE_URL=postgresql://...
OPENAI_API_KEY=sk-...
JWT_SECRET=your-super-secret-key
WEBHOOK_SECRET=whsec_...
```

### TypeScript类型定义
```typescript
// types/env.d.ts
declare namespace NodeJS {
  interface ProcessEnv {
    // 服务端环境变量
    OPENAI_API_KEY: string;
    DATABASE_URL: string;
    JWT_SECRET: string;
    
    // 客户端环境变量
    NEXT_PUBLIC_APP_NAME: string;
    NEXT_PUBLIC_API_BASE_URL: string;
  }
}
```

---

## 🛠️ 环境变量加载工具

### loadEnv.ts工具函数
```typescript
// app/utils/loadEnv.ts
interface EnvConfig {
  openai: {
    apiKey: string;
    baseUrl: string;
    model: string;
    maxTokens: number;
    temperature: number;
  };
  app: {
    name: string;
    version: string;
    debugMode: boolean;
  };
}

export function loadEnvConfig(): EnvConfig {
  // 验证必需的环境变量
  const requiredEnvs = ['OPENAI_API_KEY'];
  for (const env of requiredEnvs) {
    if (!process.env[env]) {
      throw new Error(`Missing required environment variable: ${env}`);
    }
  }

  return {
    openai: {
      apiKey: process.env.OPENAI_API_KEY!,
      baseUrl: process.env.OPENAI_BASE_URL || 'https://api.openai.com/v1',
      model: process.env.OPENAI_MODEL || 'gpt-3.5-turbo',
      maxTokens: parseInt(process.env.OPENAI_MAX_TOKENS || '2048'),
      temperature: parseFloat(process.env.OPENAI_TEMPERATURE || '0.7'),
    },
    app: {
      name: process.env.NEXT_PUBLIC_APP_NAME || 'LangGraph Chat App',
      version: process.env.NEXT_PUBLIC_APP_VERSION || '1.0.0',
      debugMode: process.env.DEBUG_MODE === 'true',
    },
  };
}
```

### 使用示例
```typescript
// app/api/chat/route.ts
import { loadEnvConfig } from '@/utils/loadEnv';

export async function POST(request: Request) {
  const config = loadEnvConfig();
  
  // 使用配置创建OpenAI客户端
  const openai = new OpenAI({
    apiKey: config.openai.apiKey,
    baseURL: config.openai.baseUrl,
  });
  
  // ... 其他逻辑
}
```

---

## 🔒 安全最佳实践

### .gitignore配置
```bash
# .gitignore
# 确保敏感文件不被提交

# 环境变量文件
.env.local
.env*.local

# 可能包含密钥的文件
*.key
*.pem
secrets/

# 日志文件
*.log
logs/

# 依赖和构建文件
node_modules/
.next/
dist/
build/
```

### 密钥管理策略
```bash
# 1. 使用强密钥
OPENAI_API_KEY=sk-proj-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

# 2. 定期轮换密钥
# 建议每个月轮换API密钥

# 3. 权限最小化
# 只给予必要的API权限

# 4. 监控使用情况
ENABLE_API_MONITORING=true
API_USAGE_ALERT_THRESHOLD=1000
```

---

## 📊 配置验证和测试

### 环境检查脚本
```typescript
// scripts/check-env.ts
import { loadEnvConfig } from '../app/utils/loadEnv';

async function checkEnvironment() {
  console.log('🔍 检查环境配置...');
  
  try {
    const config = loadEnvConfig();
    console.log('✅ 环境配置加载成功');
    
    // 测试OpenAI连接
    const openai = new OpenAI({
      apiKey: config.openai.apiKey,
    });
    
    const response = await openai.chat.completions.create({
      model: config.openai.model,
      messages: [{ role: 'user', content: 'Hello' }],
      max_tokens: 10,
    });
    
    console.log('✅ OpenAI API连接正常');
    console.log(`📊 使用模型: ${config.openai.model}`);
    
  } catch (error) {
    console.error('❌ 环境配置错误:', error.message);
    process.exit(1);
  }
}

checkEnvironment();
```

### 运行检查
```bash
# 添加到package.json scripts
"scripts": {
  "check-env": "ts-node scripts/check-env.ts",
  "dev": "npm run check-env && next dev"
}

# 运行检查
pnpm check-env
```

---

## 🌐 部署环境配置

### Vercel部署配置
```bash
# 在Vercel控制台设置环境变量
OPENAI_API_KEY=sk-...
AZURE_OPENAI_API_KEY=...
DATABASE_URL=postgresql://...

# 或使用Vercel CLI
vercel env add OPENAI_API_KEY
```

### Docker环境配置
```dockerfile
# Dockerfile
FROM node:18-alpine

WORKDIR /app

# 复制配置文件
COPY package.json pnpm-lock.yaml ./
COPY .env.production .env

# 安装依赖
RUN npm install -g pnpm
RUN pnpm install --frozen-lockfile

# 构建应用
COPY . .
RUN pnpm build

EXPOSE 3000
CMD ["pnpm", "start"]
```

### 环境变量注入
```bash
# docker-compose.yml
version: '3.8'
services:
  app:
    build: .
    ports:
      - "3000:3000"
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - DATABASE_URL=${DATABASE_URL}
    env_file:
      - .env.production
```

---

## 🛠️ 开发工作流程

### 本地开发流程
```bash
# 1. 复制环境变量模板
cp .env.example .env.local

# 2. 编辑本地配置
nano .env.local

# 3. 验证配置
pnpm check-env

# 4. 启动开发服务器
pnpm dev
```

### 团队协作流程
```bash
# 1. 提供配置模板
# .env.example (提交到Git)
OPENAI_API_KEY=your_openai_api_key_here
DATABASE_URL=your_database_url_here

# 2. 团队成员创建本地配置
cp .env.example .env.local

# 3. 填入真实的API密钥
# (不提交到Git)
```

---

## 🔧 故障排除

### 常见问题解决
```bash
# 问题1：环境变量未加载
# 检查文件名和位置
ls -la .env*

# 问题2：客户端无法访问变量
# 确保使用NEXT_PUBLIC_前缀
echo $NEXT_PUBLIC_APP_NAME

# 问题3：TypeScript类型错误
# 检查env.d.ts类型定义

# 问题4：API密钥无效
# 验证密钥格式和权限
pnpm check-env
```

### 调试技巧
```typescript
// 调试环境变量加载
console.log('Environment variables:', {
  nodeEnv: process.env.NODE_ENV,
  openaiKey: process.env.OPENAI_API_KEY ? '***' : 'undefined',
  publicAppName: process.env.NEXT_PUBLIC_APP_NAME,
});
```

---

## ✅ 配置检查清单

### 必备配置项
- [ ] 创建了.env.local文件
- [ ] 配置了OPENAI_API_KEY
- [ ] 设置了正确的.gitignore
- [ ] 定义了TypeScript类型
- [ ] 创建了配置加载工具

### 安全检查
- [ ] 敏感文件不在Git中
- [ ] API密钥格式正确
- [ ] 权限设置合理
- [ ] 定期轮换计划

### 功能验证
- [ ] 环境变量正确加载
- [ ] API连接测试通过
- [ ] 不同环境配置正确
- [ ] 部署配置完整

---

<!-- _class: lead -->
# 🎉 环境变量配置完成！

## 现在拥有安全可靠的配置管理

**下一章：前端基础开发**
